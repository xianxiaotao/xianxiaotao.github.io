<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="FRAMEWORK," />





  <link rel="alternate" href="/atom.xml" title="先小涛" type="application/atom+xml" />






<meta name="description" content="项目地址：https://github.com/bumptech/glide官方文档：http://bumptech.github.io/glide/中文文档：https://muyangmin.github.io/glide-docs-cn/原文链接：https://blog.csdn.net/guolin_blog/article/details/53939176·文章目录：Glide">
<meta property="og:type" content="article">
<meta property="og:title" content="12 Glide 源码分析执行流程">
<meta property="og:url" content="http://yoursite.com/1902/01/08/07 THIRD PARY FRAMEWORK/12 Glide 源码分析执行流程/index.html">
<meta property="og:site_name" content="先小涛">
<meta property="og:description" content="项目地址：https://github.com/bumptech/glide官方文档：http://bumptech.github.io/glide/中文文档：https://muyangmin.github.io/glide-docs-cn/原文链接：https://blog.csdn.net/guolin_blog/article/details/53939176·文章目录：Glide">
<meta property="og:updated_time" content="2020-04-04T01:07:41.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="12 Glide 源码分析执行流程">
<meta name="twitter:description" content="项目地址：https://github.com/bumptech/glide官方文档：http://bumptech.github.io/glide/中文文档：https://muyangmin.github.io/glide-docs-cn/原文链接：https://blog.csdn.net/guolin_blog/article/details/53939176·文章目录：Glide">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/1902/01/08/07 THIRD PARY FRAMEWORK/12 Glide 源码分析执行流程/"/>





  <title>12 Glide 源码分析执行流程 | 先小涛</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/xianxiaotao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">先小涛</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我至诚我道</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/1902/01/08/07 THIRD PARY FRAMEWORK/12 Glide 源码分析执行流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="先小涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="先小涛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">12 Glide 源码分析执行流程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="1902-01-08T00:00:00+08:00">
                1902-01-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FRAMEWORK/" itemprop="url" rel="index">
                    <span itemprop="name">FRAMEWORK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/1902/01/08/07 THIRD PARY FRAMEWORK/12 Glide 源码分析执行流程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/1902/01/08/07 THIRD PARY FRAMEWORK/12 Glide 源码分析执行流程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <meta name="referrer" content="no-referrer">

<blockquote>
<p>项目地址：<a href="https://github.com/bumptech/glide" target="_blank" rel="external">https://github.com/bumptech/glide</a><br>官方文档：<a href="http://bumptech.github.io/glide/" target="_blank" rel="external">http://bumptech.github.io/glide/</a><br>中文文档：<a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="external">https://muyangmin.github.io/glide-docs-cn/</a><br>原文链接：<a href="https://blog.csdn.net/guolin_blog/article/details/53939176" target="_blank" rel="external">https://blog.csdn.net/guolin_blog/article/details/53939176</a><br>·<br>文章目录：<br><a href="">Glide 快速入门</a><br><a href="">Glide 源码分析执行流程</a><br><a href="">Glide 缓存机制</a></p>
</blockquote>
<p>在多数情况下，我们想要在界面上加载并展示一张图片只需要一行代码就能实现，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Glide.with(this).load(url).into(imageView);</div></pre></td></tr></table></figure></p>
<p>虽说只有这简简单单的一行代码，但大家可能不知道的是，Glide 在背后帮我们默默执行了成吨的工作。</p>
<p>我们在平时使用 Glide 的时候格外地简单和方便，但是知其然也要知其所以然。那么今天我们就来解析一下 Glide 的源码，看看它在这些简单用法的背后，到底执行了多么复杂的工作。</p>
<h3 id="with"><a href="#with" class="headerlink" title="with()"></a>with()</h3><p>with() 方法是 Glide 类中的一组静态方法，它有好几个方法重载，我们来看一下 Glide 类中所有 with() 方法的方法重载：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class Glide &#123;</div><div class="line"></div><div class="line">    // ...</div><div class="line"></div><div class="line">    public static RequestManager with(Context context) &#123;</div><div class="line">        RequestManagerRetriever retriever = RequestManagerRetriever.get();</div><div class="line">        return retriever.get(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static RequestManager with(Activity activity) &#123;</div><div class="line">        RequestManagerRetriever retriever = RequestManagerRetriever.get();</div><div class="line">        return retriever.get(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static RequestManager with(FragmentActivity activity) &#123;</div><div class="line">        RequestManagerRetriever retriever = RequestManagerRetriever.get();</div><div class="line">        return retriever.get(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @TargetApi(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">    public static RequestManager with(android.app.Fragment fragment) &#123;</div><div class="line">        RequestManagerRetriever retriever = RequestManagerRetriever.get();</div><div class="line">        return retriever.get(fragment);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static RequestManager with(Fragment fragment) &#123;</div><div class="line">        RequestManagerRetriever retriever = RequestManagerRetriever.get();</div><div class="line">        return retriever.get(fragment);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，with() 方法的重载种类非常多，既可以传入 Activity，也可以传入 Fragment 或者是 Context。每一个 with() 方法重载的代码都非常简单，都是先调用 RequestManagerRetriever 的静态 get() 方法得到一个 RequestManagerRetriever 对象，这个静态 get() 方法就是一个单例实现，没什么需要解释的。然后再调用 RequestManagerRetriever 的实例 get() 方法，去获取 RequestManager 对象。</p>
<p>而 RequestManagerRetriever 的实例 get() 方法中的逻辑是什么样的呢？我们一起来看一看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line">public class RequestManagerRetriever implements Handler.Callback &#123;</div><div class="line"></div><div class="line">    private static final RequestManagerRetriever INSTANCE = new RequestManagerRetriever();</div><div class="line"></div><div class="line">    private volatile RequestManager applicationManager;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Retrieves and returns the RequestManagerRetriever singleton.</div><div class="line">     */</div><div class="line">    public static RequestManagerRetriever get() &#123;</div><div class="line">        return INSTANCE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private RequestManager getApplicationManager(Context context) &#123;</div><div class="line">        // Either an application context or we&apos;re on a background thread.</div><div class="line">        if (applicationManager == null) &#123;</div><div class="line">            synchronized (this) &#123;</div><div class="line">                if (applicationManager == null) &#123;</div><div class="line">                    // Normally pause/resume is taken care of by the fragment we add to the fragment or activity.</div><div class="line">                    // However, in this case since the manager attached to the application will not receive lifecycle</div><div class="line">                    // events, we must force the manager to start resumed using ApplicationLifecycle.</div><div class="line">                    applicationManager = new RequestManager(context.getApplicationContext(),</div><div class="line">                            new ApplicationLifecycle(), new EmptyRequestManagerTreeNode());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return applicationManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RequestManager get(Context context) &#123;</div><div class="line">        if (context == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;You cannot start a load on a null Context&quot;);</div><div class="line">        &#125; else if (Util.isOnMainThread() &amp;&amp; !(context instanceof Application)) &#123;</div><div class="line">            if (context instanceof FragmentActivity) &#123;</div><div class="line">                return get((FragmentActivity) context);</div><div class="line">            &#125; else if (context instanceof Activity) &#123;</div><div class="line">                return get((Activity) context);</div><div class="line">            &#125; else if (context instanceof ContextWrapper) &#123;</div><div class="line">                return get(((ContextWrapper) context).getBaseContext());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return getApplicationManager(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RequestManager get(FragmentActivity activity) &#123;</div><div class="line">        if (Util.isOnBackgroundThread()) &#123;</div><div class="line">            return get(activity.getApplicationContext());</div><div class="line">        &#125; else &#123;</div><div class="line">            assertNotDestroyed(activity);</div><div class="line">            FragmentManager fm = activity.getSupportFragmentManager();</div><div class="line">            return supportFragmentGet(activity, fm);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public RequestManager get(Fragment fragment) &#123;</div><div class="line">        if (fragment.getActivity() == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;You cannot start a load on a fragment before it is attached&quot;);</div><div class="line">        &#125;</div><div class="line">        if (Util.isOnBackgroundThread()) &#123;</div><div class="line">            return get(fragment.getActivity().getApplicationContext());</div><div class="line">        &#125; else &#123;</div><div class="line">            FragmentManager fm = fragment.getChildFragmentManager();</div><div class="line">            return supportFragmentGet(fragment.getActivity(), fm);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @TargetApi(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">    public RequestManager get(Activity activity) &#123;</div><div class="line">        if (Util.isOnBackgroundThread() || Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">            return get(activity.getApplicationContext());</div><div class="line">        &#125; else &#123;</div><div class="line">            assertNotDestroyed(activity);</div><div class="line">            android.app.FragmentManager fm = activity.getFragmentManager();</div><div class="line">            return fragmentGet(activity, fm);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR1)</div><div class="line">    private static void assertNotDestroyed(Activity activity) &#123;</div><div class="line">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1 &amp;&amp; activity.isDestroyed()) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;You cannot start a load for a destroyed activity&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR1)</div><div class="line">    public RequestManager get(android.app.Fragment fragment) &#123;</div><div class="line">        if (fragment.getActivity() == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;You cannot start a load on a fragment before it is attached&quot;);</div><div class="line">        &#125;</div><div class="line">        if (Util.isOnBackgroundThread() || Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</div><div class="line">            return get(fragment.getActivity().getApplicationContext());</div><div class="line">        &#125; else &#123;</div><div class="line">            android.app.FragmentManager fm = fragment.getChildFragmentManager();</div><div class="line">            return fragmentGet(fragment.getActivity(), fm);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR1)</div><div class="line">    RequestManagerFragment getRequestManagerFragment(final android.app.FragmentManager fm) &#123;</div><div class="line">        RequestManagerFragment current = (RequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</div><div class="line">        if (current == null) &#123;</div><div class="line">            current = pendingRequestManagerFragments.get(fm);</div><div class="line">            if (current == null) &#123;</div><div class="line">                current = new RequestManagerFragment();</div><div class="line">                pendingRequestManagerFragments.put(fm, current);</div><div class="line">                fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</div><div class="line">                handler.obtainMessage(ID_REMOVE_FRAGMENT_MANAGER, fm).sendToTarget();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return current;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @TargetApi(Build.VERSION_CODES.HONEYCOMB)</div><div class="line">    RequestManager fragmentGet(Context context, android.app.FragmentManager fm) &#123;</div><div class="line">        RequestManagerFragment current = getRequestManagerFragment(fm);</div><div class="line">        RequestManager requestManager = current.getRequestManager();</div><div class="line">        if (requestManager == null) &#123;</div><div class="line">            requestManager = new RequestManager(context, current.getLifecycle(), current.getRequestManagerTreeNode());</div><div class="line">            current.setRequestManager(requestManager);</div><div class="line">        &#125;</div><div class="line">        return requestManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SupportRequestManagerFragment getSupportRequestManagerFragment(final FragmentManager fm) &#123;</div><div class="line">        SupportRequestManagerFragment current = (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</div><div class="line">        if (current == null) &#123;</div><div class="line">            current = pendingSupportRequestManagerFragments.get(fm);</div><div class="line">            if (current == null) &#123;</div><div class="line">                current = new SupportRequestManagerFragment();</div><div class="line">                pendingSupportRequestManagerFragments.put(fm, current);</div><div class="line">                fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</div><div class="line">                handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return current;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    RequestManager supportFragmentGet(Context context, FragmentManager fm) &#123;</div><div class="line">        SupportRequestManagerFragment current = getSupportRequestManagerFragment(fm);</div><div class="line">        RequestManager requestManager = current.getRequestManager();</div><div class="line">        if (requestManager == null) &#123;</div><div class="line">            requestManager = new RequestManager(context, current.getLifecycle(), current.getRequestManagerTreeNode());</div><div class="line">            current.setRequestManager(requestManager);</div><div class="line">        &#125;</div><div class="line">        return requestManager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上述代码虽然看上去逻辑有点复杂，但是将它们梳理清楚后还是很简单的。RequestManagerRetriever 类中看似有很多个 get() 方法的重载，什么 Context 参数，Activity 参数，Fragment 参数等等，实际上只有两种情况而已，即传入 Application 类型的参数，和传入非 Application 类型的参数。</p>
<p>我们先来看传入 Application 参数的情况。如果在 Glide.with() 方法中传入的是一个 Application 对象，那么这里就会调用带有 Context 参数的 get() 方法重载，然后会在第 44 行调用 getApplicationManager() 方法来获取一个 RequestManager 对象。其实这是最简单的一种情况，因为 Application 对象的生命周期即应用程序的生命周期，因此 Glide 并不需要做什么特殊的处理，它自动就是和应用程序的生命周期是同步的，如果应用程序关闭的话， Glide 的加载也会同时终止。</p>
<p>接下来我们看传入非 Application 参数的情况。不管你在 Glide.with() 方法中传入的是 Activity、FragmentActivity、v4 包下的 Fragment、还是 app 包下的 Fragment，最终的流程都是一样的，那就是会向当前的 Activity 当中添加一个隐藏的 Fragment。具体添加的逻辑是在上述代码的第 117 行和第 141 行，分别对应的 app 包和 v4 包下的两种 Fragment 的情况。那么这里为什么要添加一个隐藏的 Fragment 呢？因为 Glide 需要知道加载的生命周期。很简单的一个道理，如果你在某个 Activity 上正在加载着一张图片，结果图片还没加载出来， Activity 就被用户关掉了，那么图片还应该继续加载吗？当然不应该。可是 Glide 并没有办法知道 Activity 的生命周期，于是 Glide 就使用了添加隐藏 Fragment 的这种小技巧，因为 Fragment 的生命周期和 Activity 是同步的，如果 Activity 被销毁了，Fragment 是可以监听到的，这样 Glide 就可以捕获这个事件并停止图片加载了。</p>
<p>这里额外再提一句，从第 48 行代码可以看出，如果我们是在非主线程当中使用的 Glide，那么不管你是传入的 Activity 还是 Fragment，都会被强制当成 Application 来处理。不过其实这就属于是在分析代码的细节了，本篇文章我们将会把目光主要放在 Glide 的主线工作流程上面，后面不会过多去分析这些细节方面的内容。</p>
<p>总体来说，第一个 with() 方法的源码还是比较好理解的。其实就是为了得到一个 RequestManager 对象而已，然后 Glide 会根据我们传入 with() 方法的参数来确定图片加载的生命周期，并没有什么特别复杂的逻辑。不过复杂的逻辑还在后面等着我们呢，接下来我们开始分析第二步，load() 方法。</p>
<h3 id="load"><a href="#load" class="headerlink" title="load()"></a>load()</h3><p>由于 with() 方法返回的是一个 RequestManager 对象，那么很容易就能想到，load() 方法是在 RequestManager 类当中的，所以说我们首先要看的就是 RequestManager 这个类。不过在上一篇文章中我们学过，Glide 是支持图片 URL 字符串、图片本地路径等等加载形式的，因此 RequestManager 中也有很多个 load() 方法的重载。但是这里我们不可能把每个 load() 方法的重载都看一遍，因此我们就只选其中一个加载图片 URL 字符串的 load() 方法来进行研究。</p>
<p>RequestManager 类的简化代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">public class RequestManager implements LifecycleListener &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns a request builder to load the given &#123;@link String&#125;.</div><div class="line">     * signature.</div><div class="line">     *</div><div class="line">     * @see #fromString()</div><div class="line">     * @see #load(Object)</div><div class="line">     *</div><div class="line">     * @param string A file path, or a uri or url handled by &#123;@link com.bumptech.glide.load.model.UriLoader&#125;.</div><div class="line">     */</div><div class="line">    public DrawableTypeRequest&lt;String&gt; load(String string) &#123;</div><div class="line">        return (DrawableTypeRequest&lt;String&gt;) fromString().load(string);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns a request builder that loads data from &#123;@link String&#125;s using an empty signature.</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     *     Note - this method caches data using only the given String as the cache key. If the data is a Uri outside of</div><div class="line">     *     your control, or you otherwise expect the data represented by the given String to change without the String</div><div class="line">     *     identifier changing, Consider using</div><div class="line">     *     &#123;@link GenericRequestBuilder#signature(Key)&#125; to mixin a signature</div><div class="line">     *     you create that identifies the data currently at the given String that will invalidate the cache if that data</div><div class="line">     *     changes. Alternatively, using &#123;@link DiskCacheStrategy#NONE&#125; and/or</div><div class="line">     *     &#123;@link DrawableRequestBuilder#skipMemoryCache(boolean)&#125; may be appropriate.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * @see #from(Class)</div><div class="line">     * @see #load(String)</div><div class="line">     */</div><div class="line">    public DrawableTypeRequest&lt;String&gt; fromString() &#123;</div><div class="line">        return loadGeneric(String.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private &lt;T&gt; DrawableTypeRequest&lt;T&gt; loadGeneric(Class&lt;T&gt; modelClass) &#123;</div><div class="line">        ModelLoader&lt;T, InputStream&gt; streamModelLoader = Glide.buildStreamModelLoader(modelClass, context);</div><div class="line">        ModelLoader&lt;T, ParcelFileDescriptor&gt; fileDescriptorModelLoader =</div><div class="line">                Glide.buildFileDescriptorModelLoader(modelClass, context);</div><div class="line">        if (modelClass != null &amp;&amp; streamModelLoader == null &amp;&amp; fileDescriptorModelLoader == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Unknown type &quot; + modelClass + &quot;. You must provide a Model of a type for&quot;</div><div class="line">                    + &quot; which there is a registered ModelLoader, if you are using a custom model, you must first call&quot;</div><div class="line">                    + &quot; Glide#register with a ModelLoaderFactory for your custom model class&quot;);</div><div class="line">        &#125;</div><div class="line">        return optionsApplier.apply(</div><div class="line">                new DrawableTypeRequest&lt;T&gt;(modelClass, streamModelLoader, fileDescriptorModelLoader, context,</div><div class="line">                        glide, requestTracker, lifecycle, optionsApplier));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RequestManager 类的代码是非常多的，但是经过我这样简化之后，看上去就比较清爽了。在我们只探究加载图片 URL 字符串这一个 load() 方法的情况下，那么比较重要的方法就只剩下上述代码中的这三个方法。</p>
<p>那么我们先来看 load() 方法，这个方法中的逻辑是非常简单的，只有一行代码，就是先调用了 fromString() 方法，再调用 load() 方法，然后把传入的图片 URL 地址传进去。而 fromString() 方法也极为简单，就是调用了 loadGeneric() 方法，并且指定参数为 String.class，因为 load() 方法传入的是一个字符串参数。那么看上去，好像主要的工作都是在 loadGeneric() 方法中进行的了。</p>
<p>其实 loadGeneric() 方法也没几行代码，这里分别调用了 Glide.buildStreamModelLoader() 方法和 Glide.buildFileDescriptorModelLoader() 方法来获得 ModelLoader 对象。ModelLoader 对象是用于加载图片的，而我们给 load() 方法传入不同类型的参数，这里也会得到不同的 ModelLoader 对象。不过 buildStreamModelLoader() 方法内部的逻辑还是蛮复杂的，这里就不展开介绍了，要不然篇幅实在收不住，感兴趣的话你可以自己研究。由于我们刚才传入的参数是 String.class，因此最终得到的是 StreamStringLoader 对象，它是实现了 ModelLoader 接口的。</p>
<p>最后我们可以看到，loadGeneric() 方法是要返回一个 DrawableTypeRequest 对象的，因此在 loadGeneric() 方法的最后又去 new 了一个 DrawableTypeRequest 对象，然后把刚才获得的 ModelLoader 对象，还有一大堆杂七杂八的东西都传了进去。具体每个参数的含义和作用就不解释了，我们只看主线流程。</p>
<p>那么这个 DrawableTypeRequest 的作用是什么呢？我们来看下它的源码，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">public class DrawableTypeRequest&lt;ModelType&gt; extends DrawableRequestBuilder&lt;ModelType&gt; implements DownloadOptions &#123;</div><div class="line">    private final ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader;</div><div class="line">    private final ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader;</div><div class="line">    private final RequestManager.OptionsApplier optionsApplier;</div><div class="line"></div><div class="line">    private static &lt;A, Z, R&gt; FixedLoadProvider&lt;A, ImageVideoWrapper, Z, R&gt; buildProvider(Glide glide,</div><div class="line">            ModelLoader&lt;A, InputStream&gt; streamModelLoader,</div><div class="line">            ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorModelLoader, Class&lt;Z&gt; resourceClass,</div><div class="line">            Class&lt;R&gt; transcodedClass,</div><div class="line">            ResourceTranscoder&lt;Z, R&gt; transcoder) &#123;</div><div class="line">        if (streamModelLoader == null &amp;&amp; fileDescriptorModelLoader == null) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (transcoder == null) &#123;</div><div class="line">            transcoder = glide.buildTranscoder(resourceClass, transcodedClass);</div><div class="line">        &#125;</div><div class="line">        DataLoadProvider&lt;ImageVideoWrapper, Z&gt; dataLoadProvider = glide.buildDataProvider(ImageVideoWrapper.class,</div><div class="line">                resourceClass);</div><div class="line">        ImageVideoModelLoader&lt;A&gt; modelLoader = new ImageVideoModelLoader&lt;A&gt;(streamModelLoader,</div><div class="line">                fileDescriptorModelLoader);</div><div class="line">        return new FixedLoadProvider&lt;A, ImageVideoWrapper, Z, R&gt;(modelLoader, transcoder, dataLoadProvider);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    DrawableTypeRequest(Class&lt;ModelType&gt; modelClass, ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader,</div><div class="line">            ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader, Context context, Glide glide,</div><div class="line">            RequestTracker requestTracker, Lifecycle lifecycle, RequestManager.OptionsApplier optionsApplier) &#123;</div><div class="line">        super(context, modelClass,</div><div class="line">                buildProvider(glide, streamModelLoader, fileDescriptorModelLoader, GifBitmapWrapper.class,</div><div class="line">                        GlideDrawable.class, null),</div><div class="line">                glide, requestTracker, lifecycle);</div><div class="line">        this.streamModelLoader = streamModelLoader;</div><div class="line">        this.fileDescriptorModelLoader = fileDescriptorModelLoader;</div><div class="line">        this.optionsApplier = optionsApplier;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Attempts to always load the resource as a &#123;@link android.graphics.Bitmap&#125;, even if it could actually be animated.</div><div class="line">     *</div><div class="line">     * @return A new request builder for loading a &#123;@link android.graphics.Bitmap&#125;</div><div class="line">     */</div><div class="line">    public BitmapTypeRequest&lt;ModelType&gt; asBitmap() &#123;</div><div class="line">        return optionsApplier.apply(new BitmapTypeRequest&lt;ModelType&gt;(this, streamModelLoader,</div><div class="line">                fileDescriptorModelLoader, optionsApplier));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Attempts to always load the resource as a &#123;@link com.bumptech.glide.load.resource.gif.GifDrawable&#125;.</div><div class="line">     * &lt;p&gt;</div><div class="line">     *     If the underlying data is not a GIF, this will fail. As a result, this should only be used if the model</div><div class="line">     *     represents an animated GIF and the caller wants to interact with the GIfDrawable directly. Normally using</div><div class="line">     *     just an &#123;@link DrawableTypeRequest&#125; is sufficient because it will determine whether or</div><div class="line">     *     not the given data represents an animated GIF and return the appropriate animated or not animated</div><div class="line">     *     &#123;@link android.graphics.drawable.Drawable&#125; automatically.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * @return A new request builder for loading a &#123;@link com.bumptech.glide.load.resource.gif.GifDrawable&#125;.</div><div class="line">     */</div><div class="line">    public GifTypeRequest&lt;ModelType&gt; asGif() &#123;</div><div class="line">        return optionsApplier.apply(new GifTypeRequest&lt;ModelType&gt;(this, streamModelLoader, optionsApplier));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个类中的代码本身就不多，我只是稍微做了一点简化。可以看到，最主要的就是它提供了 asBitmap() 和 asGif() 这两个方法。这两个方法分别是用于强制指定加载静态图片和动态图片。而从源码中可以看出，它们分别又创建了一个 BitmapTypeRequest 和 GifTypeRequest，如果没有进行强制指定的话，那默认就是使用 DrawableTypeRequest。</p>
<p>好的，那么我们再回到 RequestManager 的 load() 方法中。刚才已经分析过了，fromString() 方法会返回一个 DrawableTypeRequest 对象，接下来会调用这个对象的 load() 方法，把图片的 URL 地址传进去。但是我们刚才看到了，DrawableTypeRequest 中并没有 load() 方法，那么很容易就能猜想到，load() 方法是在父类当中的。</p>
<p>DrawableTypeRequest 的父类是 DrawableRequestBuilder，我们来看下这个类的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div></pre></td><td class="code"><pre><div class="line">public class DrawableRequestBuilder&lt;ModelType&gt;</div><div class="line">        extends GenericRequestBuilder&lt;ModelType, ImageVideoWrapper, GifBitmapWrapper, GlideDrawable&gt;</div><div class="line">        implements BitmapOptions, DrawableOptions &#123;</div><div class="line"></div><div class="line">    DrawableRequestBuilder(Context context, Class&lt;ModelType&gt; modelClass,</div><div class="line">            LoadProvider&lt;ModelType, ImageVideoWrapper, GifBitmapWrapper, GlideDrawable&gt; loadProvider, Glide glide,</div><div class="line">            RequestTracker requestTracker, Lifecycle lifecycle) &#123;</div><div class="line">        super(context, modelClass, loadProvider, GlideDrawable.class, glide, requestTracker, lifecycle);</div><div class="line">        // Default to animating.</div><div class="line">        crossFade();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; thumbnail(</div><div class="line">            DrawableRequestBuilder&lt;?&gt; thumbnailRequest) &#123;</div><div class="line">        super.thumbnail(thumbnailRequest);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; thumbnail(</div><div class="line">            GenericRequestBuilder&lt;?, ?, ?, GlideDrawable&gt; thumbnailRequest) &#123;</div><div class="line">        super.thumbnail(thumbnailRequest);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; thumbnail(float sizeMultiplier) &#123;</div><div class="line">        super.thumbnail(sizeMultiplier);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; sizeMultiplier(float sizeMultiplier) &#123;</div><div class="line">        super.sizeMultiplier(sizeMultiplier);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; decoder(ResourceDecoder&lt;ImageVideoWrapper, GifBitmapWrapper&gt; decoder) &#123;</div><div class="line">        super.decoder(decoder);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; cacheDecoder(ResourceDecoder&lt;File, GifBitmapWrapper&gt; cacheDecoder) &#123;</div><div class="line">        super.cacheDecoder(cacheDecoder);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; encoder(ResourceEncoder&lt;GifBitmapWrapper&gt; encoder) &#123;</div><div class="line">        super.encoder(encoder);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; priority(Priority priority) &#123;</div><div class="line">        super.priority(priority);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; transform(BitmapTransformation... transformations) &#123;</div><div class="line">        return bitmapTransform(transformations);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; centerCrop() &#123;</div><div class="line">        return transform(glide.getDrawableCenterCrop());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; fitCenter() &#123;</div><div class="line">        return transform(glide.getDrawableFitCenter());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; bitmapTransform(Transformation&lt;Bitmap&gt;... bitmapTransformations) &#123;</div><div class="line">        GifBitmapWrapperTransformation[] transformations =</div><div class="line">                new GifBitmapWrapperTransformation[bitmapTransformations.length];</div><div class="line">        for (int i = 0; i &lt; bitmapTransformations.length; i++) &#123;</div><div class="line">            transformations[i] = new GifBitmapWrapperTransformation(glide.getBitmapPool(), bitmapTransformations[i]);</div><div class="line">        &#125;</div><div class="line">        return transform(transformations);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; transform(Transformation&lt;GifBitmapWrapper&gt;... transformation) &#123;</div><div class="line">        super.transform(transformation);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; transcoder(</div><div class="line">            ResourceTranscoder&lt;GifBitmapWrapper, GlideDrawable&gt; transcoder) &#123;</div><div class="line">        super.transcoder(transcoder);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public final DrawableRequestBuilder&lt;ModelType&gt; crossFade() &#123;</div><div class="line">        super.animate(new DrawableCrossFadeFactory&lt;GlideDrawable&gt;());</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; crossFade(int duration) &#123;</div><div class="line">        super.animate(new DrawableCrossFadeFactory&lt;GlideDrawable&gt;(duration));</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; crossFade(int animationId, int duration) &#123;</div><div class="line">        super.animate(new DrawableCrossFadeFactory&lt;GlideDrawable&gt;(context, animationId,</div><div class="line">                duration));</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; dontAnimate() &#123;</div><div class="line">        super.dontAnimate();</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; animate(ViewPropertyAnimation.Animator animator) &#123;</div><div class="line">        super.animate(animator);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; animate(int animationId) &#123;</div><div class="line">        super.animate(animationId);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; placeholder(int resourceId) &#123;</div><div class="line">        super.placeholder(resourceId);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; placeholder(Drawable drawable) &#123;</div><div class="line">        super.placeholder(drawable);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; fallback(Drawable drawable) &#123;</div><div class="line">        super.fallback(drawable);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; fallback(int resourceId) &#123;</div><div class="line">        super.fallback(resourceId);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; error(int resourceId) &#123;</div><div class="line">        super.error(resourceId);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; error(Drawable drawable) &#123;</div><div class="line">        super.error(drawable);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; listener(</div><div class="line">            RequestListener&lt;? super ModelType, GlideDrawable&gt; requestListener) &#123;</div><div class="line">        super.listener(requestListener);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; diskCacheStrategy(DiskCacheStrategy strategy) &#123;</div><div class="line">        super.diskCacheStrategy(strategy);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; skipMemoryCache(boolean skip) &#123;</div><div class="line">        super.skipMemoryCache(skip);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; override(int width, int height) &#123;</div><div class="line">        super.override(width, height);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; sourceEncoder(Encoder&lt;ImageVideoWrapper&gt; sourceEncoder) &#123;</div><div class="line">        super.sourceEncoder(sourceEncoder);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; dontTransform() &#123;</div><div class="line">        super.dontTransform();</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; signature(Key signature) &#123;</div><div class="line">        super.signature(signature);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; load(ModelType model) &#123;</div><div class="line">        super.load(model);</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DrawableRequestBuilder&lt;ModelType&gt; clone() &#123;</div><div class="line">        return (DrawableRequestBuilder&lt;ModelType&gt;) super.clone();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Target&lt;GlideDrawable&gt; into(ImageView view) &#123;</div><div class="line">        return super.into(view);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    void applyFitCenter() &#123;</div><div class="line">        fitCenter();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    void applyCenterCrop() &#123;</div><div class="line">        centerCrop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DrawableRequestBuilder 中有很多个方法，这些方法其实就是 Glide 绝大多数的 API 了。里面有不少我们在上篇文章中已经用过了，比如说 placeholder() 方法、error() 方法、diskCacheStrategy() 方法、override() 方法等。当然还有很多暂时还没用到的 API，我们会在后面的文章当中学习。</p>
<p>到这里，第二步 load() 方法也就分析结束了。为什么呢？因为你会发现 DrawableRequestBuilder 类中有一个 into() 方法（上述代码第 220 行），也就是说，最终 load() 方法返回的其实就是一个 DrawableTypeRequest 对象。那么接下来我们就要进行第三步了，分析 into() 方法中的逻辑。</p>
<h3 id="into"><a href="#into" class="headerlink" title="into()"></a>into()</h3><p>如果说前面两步都是在准备开胃小菜的话，那么现在终于要进入主菜了，因为 into() 方法也是整个 Glide 图片加载流程中逻辑最复杂的地方。</p>
<p>不过从刚才的代码来看，into() 方法中并没有任何逻辑，只有一句 super.into(view)。那么很显然，into() 方法的具体逻辑都是在 DrawableRequestBuilder 的父类当中了。</p>
<p>DrawableRequestBuilder 的父类是 GenericRequestBuilder，我们来看一下 GenericRequestBuilder 类中的 into() 方法，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public Target&lt;TranscodeType&gt; into(ImageView view) &#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    if (view == null) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;You must pass in a non null View&quot;);</div><div class="line">    &#125;</div><div class="line">    if (!isTransformationSet &amp;&amp; view.getScaleType() != null) &#123;</div><div class="line">        switch (view.getScaleType()) &#123;</div><div class="line">            case CENTER_CROP:</div><div class="line">                applyCenterCrop();</div><div class="line">                break;</div><div class="line">            case FIT_CENTER:</div><div class="line">            case FIT_START:</div><div class="line">            case FIT_END:</div><div class="line">                applyFitCenter();</div><div class="line">                break;</div><div class="line">            //$CASES-OMITTED$</div><div class="line">            default:</div><div class="line">                // Do nothing.</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return into(glide.buildImageViewTarget(view, transcodeClass));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里前面一大堆的判断逻辑我们都可以先不用管，等到后面文章讲 transform 的时候会再进行解释，现在我们只需要关注最后一行代码。最后一行代码先是调用了 glide.buildImageViewTarget() 方法，这个方法会构建出一个 Target 对象，Target 对象则是用来最终展示图片用的，如果我们跟进去的话会看到如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;R&gt; Target&lt;R&gt; buildImageViewTarget(ImageView imageView, Class&lt;R&gt; transcodedClass) &#123;</div><div class="line">    return imageViewTargetFactory.buildTarget(imageView, transcodedClass);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里其实又是调用了 ImageViewTargetFactory 的 buildTarget() 方法，我们继续跟进去，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class ImageViewTargetFactory &#123;</div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    public &lt;Z&gt; Target&lt;Z&gt; buildTarget(ImageView view, Class&lt;Z&gt; clazz) &#123;</div><div class="line">        if (GlideDrawable.class.isAssignableFrom(clazz)) &#123;</div><div class="line">            return (Target&lt;Z&gt;) new GlideDrawableImageViewTarget(view);</div><div class="line">        &#125; else if (Bitmap.class.equals(clazz)) &#123;</div><div class="line">            return (Target&lt;Z&gt;) new BitmapImageViewTarget(view);</div><div class="line">        &#125; else if (Drawable.class.isAssignableFrom(clazz)) &#123;</div><div class="line">            return (Target&lt;Z&gt;) new DrawableImageViewTarget(view);</div><div class="line">        &#125; else &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Unhandled class: &quot; + clazz</div><div class="line">                    + &quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在 buildTarget() 方法中会根据传入的 class 参数来构建不同的 Target 对象。那如果你要分析这个 class 参数是从哪儿传过来的，这可有得你分析了，简单起见我直接帮大家梳理清楚。这个 class 参数其实基本上只有两种情况，如果你在使用 Glide 加载图片的时候调用了 asBitmap() 方法，那么这里就会构建出 BitmapImageViewTarget 对象，否则的话构建的都是 GlideDrawableImageViewTarget 对象。至于上述代码中的 DrawableImageViewTarget 对象，这个通常都是用不到的，我们可以暂时不用管它。</p>
<p>也就是说，通过 glide.buildImageViewTarget() 方法，我们构建出了一个 GlideDrawableImageViewTarget 对象。那现在回到刚才 into() 方法的最后一行，可以看到，这里又将这个参数传入到了 GenericRequestBuilder 另一个接收 Target 对象的 into() 方法当中了。我们来看一下这个 into() 方法的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public &lt;Y extends Target&lt;TranscodeType&gt;&gt; Y into(Y target) &#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    if (target == null) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;You must pass in a non null Target&quot;);</div><div class="line">    &#125;</div><div class="line">    if (!isModelSet) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;You must first set a model (try #load())&quot;);</div><div class="line">    &#125;</div><div class="line">    Request previous = target.getRequest();</div><div class="line">    if (previous != null) &#123;</div><div class="line">        previous.clear();</div><div class="line">        requestTracker.removeRequest(previous);</div><div class="line">        previous.recycle();</div><div class="line">    &#125;</div><div class="line">    Request request = buildRequest(target);</div><div class="line">    target.setRequest(request);</div><div class="line">    lifecycle.addListener(target);</div><div class="line">    requestTracker.runRequest(request);</div><div class="line">    return target;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们还是只抓核心代码，其实只有两行是最关键的，第 15 行调用 buildRequest() 方法构建出了一个 Request 对象，还有第 18 行来执行这个 Request。</p>
<p>Request 是用来发出加载图片请求的，它是 Glide 中非常关键的一个组件。我们先来看 buildRequest() 方法是如何构建 Request 对象的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">private Request buildRequest(Target&lt;TranscodeType&gt; target) &#123;</div><div class="line">    if (priority == null) &#123;</div><div class="line">        priority = Priority.NORMAL;</div><div class="line">    &#125;</div><div class="line">    return buildRequestRecursive(target, null);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private Request buildRequestRecursive(Target&lt;TranscodeType&gt; target, ThumbnailRequestCoordinator parentCoordinator) &#123;</div><div class="line">    if (thumbnailRequestBuilder != null) &#123;</div><div class="line">        if (isThumbnailBuilt) &#123;</div><div class="line">            throw new IllegalStateException(&quot;You cannot use a request as both the main request and a thumbnail, &quot;</div><div class="line">                    + &quot;consider using clone() on the request(s) passed to thumbnail()&quot;);</div><div class="line">        &#125;</div><div class="line">        // Recursive case: contains a potentially recursive thumbnail request builder.</div><div class="line">        if (thumbnailRequestBuilder.animationFactory.equals(NoAnimation.getFactory())) &#123;</div><div class="line">            thumbnailRequestBuilder.animationFactory = animationFactory;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (thumbnailRequestBuilder.priority == null) &#123;</div><div class="line">            thumbnailRequestBuilder.priority = getThumbnailPriority();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (Util.isValidDimensions(overrideWidth, overrideHeight)</div><div class="line">                &amp;&amp; !Util.isValidDimensions(thumbnailRequestBuilder.overrideWidth,</div><div class="line">                        thumbnailRequestBuilder.overrideHeight)) &#123;</div><div class="line">          thumbnailRequestBuilder.override(overrideWidth, overrideHeight);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ThumbnailRequestCoordinator coordinator = new ThumbnailRequestCoordinator(parentCoordinator);</div><div class="line">        Request fullRequest = obtainRequest(target, sizeMultiplier, priority, coordinator);</div><div class="line">        // Guard against infinite recursion.</div><div class="line">        isThumbnailBuilt = true;</div><div class="line">        // Recursively generate thumbnail requests.</div><div class="line">        Request thumbRequest = thumbnailRequestBuilder.buildRequestRecursive(target, coordinator);</div><div class="line">        isThumbnailBuilt = false;</div><div class="line">        coordinator.setRequests(fullRequest, thumbRequest);</div><div class="line">        return coordinator;</div><div class="line">    &#125; else if (thumbSizeMultiplier != null) &#123;</div><div class="line">        // Base case: thumbnail multiplier generates a thumbnail request, but cannot recurse.</div><div class="line">        ThumbnailRequestCoordinator coordinator = new ThumbnailRequestCoordinator(parentCoordinator);</div><div class="line">        Request fullRequest = obtainRequest(target, sizeMultiplier, priority, coordinator);</div><div class="line">        Request thumbnailRequest = obtainRequest(target, thumbSizeMultiplier, getThumbnailPriority(), coordinator);</div><div class="line">        coordinator.setRequests(fullRequest, thumbnailRequest);</div><div class="line">        return coordinator;</div><div class="line">    &#125; else &#123;</div><div class="line">        // Base case: no thumbnail.</div><div class="line">        return obtainRequest(target, sizeMultiplier, priority, parentCoordinator);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private Request obtainRequest(Target&lt;TranscodeType&gt; target, float sizeMultiplier, Priority priority,</div><div class="line">        RequestCoordinator requestCoordinator) &#123;</div><div class="line">    return GenericRequest.obtain(</div><div class="line">            loadProvider,</div><div class="line">            model,</div><div class="line">            signature,</div><div class="line">            context,</div><div class="line">            priority,</div><div class="line">            target,</div><div class="line">            sizeMultiplier,</div><div class="line">            placeholderDrawable,</div><div class="line">            placeholderId,</div><div class="line">            errorPlaceholder,</div><div class="line">            errorId,</div><div class="line">            fallbackDrawable,</div><div class="line">            fallbackResource,</div><div class="line">            requestListener,</div><div class="line">            requestCoordinator,</div><div class="line">            glide.getEngine(),</div><div class="line">            transformation,</div><div class="line">            transcodeClass,</div><div class="line">            isCacheable,</div><div class="line">            animationFactory,</div><div class="line">            overrideWidth,</div><div class="line">            overrideHeight,</div><div class="line">            diskCacheStrategy);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，buildRequest() 方法的内部其实又调用了 buildRequestRecursive() 方法，而 buildRequestRecursive() 方法中的代码虽然有点长，但是其中 90% 的代码都是在处理缩略图的。如果我们只追主线流程的话，那么只需要看第 47 行代码就可以了。这里调用了 obtainRequest() 方法来获取一个 Request 对象，而 obtainRequest() 方法中又去调用了 GenericRequest 的 obtain() 方法。注意这个 obtain() 方法需要传入非常多的参数，而其中很多的参数我们都是比较熟悉的，像什么 placeholderId、errorPlaceholder、diskCacheStrategy 等等。因此，我们就有理由猜测，刚才在 load()方法中调用的所有 API，其实都是在这里组装到 Request 对象当中的。那么我们进入到这个 GenericRequest 的 obtain() 方法瞧一瞧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">public final class GenericRequest&lt;A, T, Z, R&gt; implements Request, SizeReadyCallback,</div><div class="line">        ResourceCallback &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    public static &lt;A, T, Z, R&gt; GenericRequest&lt;A, T, Z, R&gt; obtain(</div><div class="line">            LoadProvider&lt;A, T, Z, R&gt; loadProvider,</div><div class="line">            A model,</div><div class="line">            Key signature,</div><div class="line">            Context context,</div><div class="line">            Priority priority,</div><div class="line">            Target&lt;R&gt; target,</div><div class="line">            float sizeMultiplier,</div><div class="line">            Drawable placeholderDrawable,</div><div class="line">            int placeholderResourceId,</div><div class="line">            Drawable errorDrawable,</div><div class="line">            int errorResourceId,</div><div class="line">            Drawable fallbackDrawable,</div><div class="line">            int fallbackResourceId,</div><div class="line">            RequestListener&lt;? super A, R&gt; requestListener,</div><div class="line">            RequestCoordinator requestCoordinator,</div><div class="line">            Engine engine,</div><div class="line">            Transformation&lt;Z&gt; transformation,</div><div class="line">            Class&lt;R&gt; transcodeClass,</div><div class="line">            boolean isMemoryCacheable,</div><div class="line">            GlideAnimationFactory&lt;R&gt; animationFactory,</div><div class="line">            int overrideWidth,</div><div class="line">            int overrideHeight,</div><div class="line">            DiskCacheStrategy diskCacheStrategy) &#123;</div><div class="line">        @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">        GenericRequest&lt;A, T, Z, R&gt; request = (GenericRequest&lt;A, T, Z, R&gt;) REQUEST_POOL.poll();</div><div class="line">        if (request == null) &#123;</div><div class="line">            request = new GenericRequest&lt;A, T, Z, R&gt;();</div><div class="line">        &#125;</div><div class="line">        request.init(loadProvider,</div><div class="line">                model,</div><div class="line">                signature,</div><div class="line">                context,</div><div class="line">                priority,</div><div class="line">                target,</div><div class="line">                sizeMultiplier,</div><div class="line">                placeholderDrawable,</div><div class="line">                placeholderResourceId,</div><div class="line">                errorDrawable,</div><div class="line">                errorResourceId,</div><div class="line">                fallbackDrawable,</div><div class="line">                fallbackResourceId,</div><div class="line">                requestListener,</div><div class="line">                requestCoordinator,</div><div class="line">                engine,</div><div class="line">                transformation,</div><div class="line">                transcodeClass,</div><div class="line">                isMemoryCacheable,</div><div class="line">                animationFactory,</div><div class="line">                overrideWidth,</div><div class="line">                overrideHeight,</div><div class="line">                diskCacheStrategy);</div><div class="line">        return request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在第 33 行去 new 了一个 GenericRequest 对象，并在最后一行返回，也就是说，obtain() 方法实际上获得的就是一个 GenericRequest 对象。另外这里又在第 35 行调用了 GenericRequest 的 init()，里面主要就是一些赋值的代码，将传入的这些参数赋值到 GenericRequest 的成员变量当中，我们就不再跟进去看了。</p>
<p>好，那现在解决了构建 Request 对象的问题，接下来我们看一下这个 Request 对象又是怎么执行的。回到刚才的 into() 方法，你会发现在第 18 行调用了 requestTracker.runRequest() 方法来去执行这个 Request，那么我们跟进去瞧一瞧，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Starts tracking the given request.</div><div class="line"> */</div><div class="line">public void runRequest(Request request) &#123;</div><div class="line">    requests.add(request);</div><div class="line">    if (!isPaused) &#123;</div><div class="line">        request.begin();</div><div class="line">    &#125; else &#123;</div><div class="line">        pendingRequests.add(request);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里有一个简单的逻辑判断，就是先判断 Glide 当前是不是处理暂停状态，如果不是暂停状态就调用 Request 的 begin() 方法来执行 Request，否则的话就先将 Request 添加到待执行队列里面，等暂停状态解除了之后再执行。</p>
<p>暂停请求的功能仍然不是这篇文章所关心的，这里就直接忽略了，我们重点来看这个 begin() 方法。由于当前的 Request 对象是一个 GenericRequest，因此这里就需要看 GenericRequest 中的 begin() 方法了，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void begin() &#123;</div><div class="line">    startTime = LogTime.getLogTime();</div><div class="line">    if (model == null) &#123;</div><div class="line">        onException(null);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    status = Status.WAITING_FOR_SIZE;</div><div class="line">    if (Util.isValidDimensions(overrideWidth, overrideHeight)) &#123;</div><div class="line">        onSizeReady(overrideWidth, overrideHeight);</div><div class="line">    &#125; else &#123;</div><div class="line">        target.getSize(this);</div><div class="line">    &#125;</div><div class="line">    if (!isComplete() &amp;&amp; !isFailed() &amp;&amp; canNotifyStatusChanged()) &#123;</div><div class="line">        target.onLoadStarted(getPlaceholderDrawable());</div><div class="line">    &#125;</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logV(&quot;finished run method in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们来注意几个细节，首先如果 model 等于 null，model 也就是我们在第二步 load() 方法中传入的图片 URL 地址，这个时候会调用 onException() 方法。如果你跟到 onException() 方法里面去看看，你会发现它最终会调用到一个 setErrorPlaceholder() 当中，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">private void setErrorPlaceholder(Exception e) &#123;</div><div class="line">    if (!canNotifyStatusChanged()) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    Drawable error = model == null ? getFallbackDrawable() : null;</div><div class="line">    if (error == null) &#123;</div><div class="line">      error = getErrorDrawable();</div><div class="line">    &#125;</div><div class="line">    if (error == null) &#123;</div><div class="line">        error = getPlaceholderDrawable();</div><div class="line">    &#125;</div><div class="line">    target.onLoadFailed(e, error);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法中会先去获取一个 error 的占位图，如果获取不到的话会再去获取一个 loading 占位图，然后调用 target.onLoadFailed() 方法并将占位图传入。那么 onLoadFailed() 方法中做了什么呢？我们看一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public abstract class ImageViewTarget&lt;Z&gt; extends ViewTarget&lt;ImageView, Z&gt; implements GlideAnimation.ViewAdapter &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onLoadStarted(Drawable placeholder) &#123;</div><div class="line">        view.setImageDrawable(placeholder);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onLoadFailed(Exception e, Drawable errorDrawable) &#123;</div><div class="line">        view.setImageDrawable(errorDrawable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>很简单，其实就是将这张 error 占位图显示到 ImageView 上而已，因为现在出现了异常，没办法展示正常的图片了。而如果你仔细看下刚才 begin() 方法的第 15 行，你会发现它又调用了一个 target.onLoadStarted() 方法，并传入了一个 loading 占位图，在也就说，在图片请求开始之前，会先使用这张占位图代替最终的图片显示。这也是我们在上一篇文章中学过的 placeholder() 和 error() 这两个占位图 API 底层的实现原理。</p>
<p>好，那么我们继续回到 begin() 方法。刚才讲了占位图的实现，那么具体的图片加载又是从哪里开始的呢？是在 begin() 方法的第 10 行和第 12 行。这里要分两种情况，一种是你使用了 override() API 为图片指定了一个固定的宽高，一种是没有指定。如果指定了的话，就会执行第 10 行代码，调用 onSizeReady() 方法。如果没指定的话，就会执行第 12 行代码，调用 target.getSize() 方法。这个 target.getSize() 方法的内部会根据 ImageView 的 layout_width 和 layout_height 值做一系列的计算，来算出图片应该的宽高。具体的计算细节我就不带着大家分析了，总之在计算完之后，它也会调用 onSizeReady() 方法。也就是说，不管是哪种情况，最终都会调用到 onSizeReady() 方法，在这里进行下一步操作。那么我们跟到这个方法里面来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void onSizeReady(int width, int height) &#123;</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logV(&quot;Got onSizeReady in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">    &#125;</div><div class="line">    if (status != Status.WAITING_FOR_SIZE) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    status = Status.RUNNING;</div><div class="line">    width = Math.round(sizeMultiplier * width);</div><div class="line">    height = Math.round(sizeMultiplier * height);</div><div class="line">    ModelLoader&lt;A, T&gt; modelLoader = loadProvider.getModelLoader();</div><div class="line">    final DataFetcher&lt;T&gt; dataFetcher = modelLoader.getResourceFetcher(model, width, height);</div><div class="line">    if (dataFetcher == null) &#123;</div><div class="line">        onException(new Exception(&quot;Failed to load model: \&apos;&quot; + model + &quot;\&apos;&quot;));</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    ResourceTranscoder&lt;Z, R&gt; transcoder = loadProvider.getTranscoder();</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logV(&quot;finished setup for calling load in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">    &#125;</div><div class="line">    loadedFromMemoryCache = true;</div><div class="line">    loadStatus = engine.load(signature, width, height, dataFetcher, loadProvider, transformation, transcoder,</div><div class="line">            priority, isMemoryCacheable, diskCacheStrategy, this);</div><div class="line">    loadedFromMemoryCache = resource != null;</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logV(&quot;finished onSizeReady in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从这里开始，真正复杂的地方来了，我们需要慢慢进行分析。先来看一下，在第12行调用了 loadProvider.getModelLoader() 方法，那么我们第一个要搞清楚的就是，这个 loadProvider 是什么？要搞清楚这点，需要先回到第二步的 load() 方法当中。还记得 load() 方法是返回一个 DrawableTypeRequest 对象吗？刚才我们只是分析了 DrawableTypeRequest 当中的 asBitmap() 和 asGif() 方法，并没有仔细看它的构造函数，现在我们重新来看一下 DrawableTypeRequest类的构造函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public class DrawableTypeRequest&lt;ModelType&gt; extends DrawableRequestBuilder&lt;ModelType&gt; implements DownloadOptions &#123;</div><div class="line"></div><div class="line">    private final ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader;</div><div class="line">    private final ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader;</div><div class="line">    private final RequestManager.OptionsApplier optionsApplier;</div><div class="line"></div><div class="line">    private static &lt;A, Z, R&gt; FixedLoadProvider&lt;A, ImageVideoWrapper, Z, R&gt; buildProvider(Glide glide,</div><div class="line">            ModelLoader&lt;A, InputStream&gt; streamModelLoader,</div><div class="line">            ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorModelLoader, Class&lt;Z&gt; resourceClass,</div><div class="line">            Class&lt;R&gt; transcodedClass,</div><div class="line">            ResourceTranscoder&lt;Z, R&gt; transcoder) &#123;</div><div class="line">        if (streamModelLoader == null &amp;&amp; fileDescriptorModelLoader == null) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">        if (transcoder == null) &#123;</div><div class="line">            transcoder = glide.buildTranscoder(resourceClass, transcodedClass);</div><div class="line">        &#125;</div><div class="line">        DataLoadProvider&lt;ImageVideoWrapper, Z&gt; dataLoadProvider = glide.buildDataProvider(ImageVideoWrapper.class,</div><div class="line">                resourceClass);</div><div class="line">        ImageVideoModelLoader&lt;A&gt; modelLoader = new ImageVideoModelLoader&lt;A&gt;(streamModelLoader,</div><div class="line">                fileDescriptorModelLoader);</div><div class="line">        return new FixedLoadProvider&lt;A, ImageVideoWrapper, Z, R&gt;(modelLoader, transcoder, dataLoadProvider);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    DrawableTypeRequest(Class&lt;ModelType&gt; modelClass, ModelLoader&lt;ModelType, InputStream&gt; streamModelLoader,</div><div class="line">            ModelLoader&lt;ModelType, ParcelFileDescriptor&gt; fileDescriptorModelLoader, Context context, Glide glide,</div><div class="line">            RequestTracker requestTracker, Lifecycle lifecycle, RequestManager.OptionsApplier optionsApplier) &#123;</div><div class="line">        super(context, modelClass,</div><div class="line">                buildProvider(glide, streamModelLoader, fileDescriptorModelLoader, GifBitmapWrapper.class,</div><div class="line">                        GlideDrawable.class, null),</div><div class="line">                glide, requestTracker, lifecycle);</div><div class="line">        this.streamModelLoader = streamModelLoader;</div><div class="line">        this.fileDescriptorModelLoader = fileDescriptorModelLoader;</div><div class="line">        this.optionsApplier = optionsApplier;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在第 29 行，也就是构造函数中，调用了一个 buildProvider() 方法，并把 streamModelLoader 和 fileDescriptorModelLoader 等参数传入到这个方法中，这两个 ModelLoader 就是之前在 loadGeneric() 方法中构建出来的。</p>
<p>那么我们再来看一下 buildProvider() 方法里面做了什么，在第 16 行调用了 glide.buildTranscoder() 方法来构建一个 ResourceTranscoder，它是用于对图片进行转码的，由于 ResourceTranscoder 是一个接口，这里实际会构建出一个 GifBitmapWrapperDrawableTranscoder 对象。</p>
<p>接下来在第 18 行调用了 glide.buildDataProvider() 方法来构建一个 DataLoadProvider，它是用于对图片进行编解码的，由于 DataLoadProvider 是一个接口，这里实际会构建出一个 ImageVideoGifDrawableLoadProvider 对象。</p>
<p>然后在第 20 行，new 了一个 ImageVideoModelLoader 的实例，并把之前 loadGeneric() 方法中构建的两个 ModelLoader 封装到了 ImageVideoModelLoader 当中。</p>
<p>最后，在第 22 行，new 出一个 FixedLoadProvider，并把刚才构建的出来的 GifBitmapWrapperDrawableTranscoder、ImageVideoModelLoader、ImageVideoGifDrawableLoadProvider 都封装进去，这个也就是 onSizeReady() 方法中的 loadProvider 了。</p>
<p>好的，那么我们回到 onSizeReady() 方法中，在 onSizeReady() 方法的第 12 行和第 18 行，分别调用了 loadProvider 的 getModelLoader() 方法和 getTranscoder() 方法，那么得到的对象也就是刚才我们分析的 ImageVideoModelLoader 和 GifBitmapWrapperDrawableTranscoder 了。而在第 13 行，又调用了 ImageVideoModelLoader 的 getResourceFetcher() 方法，这里我们又需要跟进去瞧一瞧了，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public class ImageVideoModelLoader&lt;A&gt; implements ModelLoader&lt;A, ImageVideoWrapper&gt; &#123;</div><div class="line">    private static final String TAG = &quot;IVML&quot;;</div><div class="line"></div><div class="line">    private final ModelLoader&lt;A, InputStream&gt; streamLoader;</div><div class="line">    private final ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorLoader;</div><div class="line"></div><div class="line">    public ImageVideoModelLoader(ModelLoader&lt;A, InputStream&gt; streamLoader,</div><div class="line">            ModelLoader&lt;A, ParcelFileDescriptor&gt; fileDescriptorLoader) &#123;</div><div class="line">        if (streamLoader == null &amp;&amp; fileDescriptorLoader == null) &#123;</div><div class="line">            throw new NullPointerException(&quot;At least one of streamLoader and fileDescriptorLoader must be non null&quot;);</div><div class="line">        &#125;</div><div class="line">        this.streamLoader = streamLoader;</div><div class="line">        this.fileDescriptorLoader = fileDescriptorLoader;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public DataFetcher&lt;ImageVideoWrapper&gt; getResourceFetcher(A model, int width, int height) &#123;</div><div class="line">        DataFetcher&lt;InputStream&gt; streamFetcher = null;</div><div class="line">        if (streamLoader != null) &#123;</div><div class="line">            streamFetcher = streamLoader.getResourceFetcher(model, width, height);</div><div class="line">        &#125;</div><div class="line">        DataFetcher&lt;ParcelFileDescriptor&gt; fileDescriptorFetcher = null;</div><div class="line">        if (fileDescriptorLoader != null) &#123;</div><div class="line">            fileDescriptorFetcher = fileDescriptorLoader.getResourceFetcher(model, width, height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (streamFetcher != null || fileDescriptorFetcher != null) &#123;</div><div class="line">            return new ImageVideoFetcher(streamFetcher, fileDescriptorFetcher);</div><div class="line">        &#125; else &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static class ImageVideoFetcher implements DataFetcher&lt;ImageVideoWrapper&gt; &#123;</div><div class="line">        private final DataFetcher&lt;InputStream&gt; streamFetcher;</div><div class="line">        private final DataFetcher&lt;ParcelFileDescriptor&gt; fileDescriptorFetcher;</div><div class="line"></div><div class="line">        public ImageVideoFetcher(DataFetcher&lt;InputStream&gt; streamFetcher,</div><div class="line">                DataFetcher&lt;ParcelFileDescriptor&gt; fileDescriptorFetcher) &#123;</div><div class="line">            this.streamFetcher = streamFetcher;</div><div class="line">            this.fileDescriptorFetcher = fileDescriptorFetcher;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在第 20 行会先调用 streamLoader.getResourceFetcher() 方法获取一个 DataFetcher，而这个 streamLoader 其实就是我们在 loadGeneric() 方法中构建出的 StreamStringLoader，调用它的 getResourceFetcher() 方法会得到一个 HttpUrlFetcher 对象。然后在第 28 行 new 出了一个 ImageVideoFetcher 对象，并把获得的 HttpUrlFetcher 对象传进去。也就是说，ImageVideoModelLoader 的 getResourceFetcher() 方法得到的是一个 ImageVideoFetcher。</p>
<p>那么我们再次回到 onSizeReady() 方法，在 onSizeReady() 方法的第 23 行，这里将刚才获得的 ImageVideoFetcher、GifBitmapWrapperDrawableTranscoder 等等一系列的值一起传入到了 Engine 的 load() 方法当中。接下来我们就要看一看，这个 Engine 的 load() 方法当中，到底做了什么？代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">public class Engine implements EngineJobListener,</div><div class="line">        MemoryCache.ResourceRemovedListener,</div><div class="line">        EngineResource.ResourceListener &#123;</div><div class="line"></div><div class="line">    ...    </div><div class="line"></div><div class="line">    public &lt;T, Z, R&gt; LoadStatus load(Key signature, int width, int height, DataFetcher&lt;T&gt; fetcher,</div><div class="line">            DataLoadProvider&lt;T, Z&gt; loadProvider, Transformation&lt;Z&gt; transformation, ResourceTranscoder&lt;Z, R&gt; transcoder,</div><div class="line">            Priority priority, boolean isMemoryCacheable, DiskCacheStrategy diskCacheStrategy, ResourceCallback cb) &#123;</div><div class="line">        Util.assertMainThread();</div><div class="line">        long startTime = LogTime.getLogTime();</div><div class="line"></div><div class="line">        final String id = fetcher.getId();</div><div class="line">        EngineKey key = keyFactory.buildKey(id, signature, width, height, loadProvider.getCacheDecoder(),</div><div class="line">                loadProvider.getSourceDecoder(), transformation, loadProvider.getEncoder(),</div><div class="line">                transcoder, loadProvider.getSourceEncoder());</div><div class="line"></div><div class="line">        EngineResource&lt;?&gt; cached = loadFromCache(key, isMemoryCacheable);</div><div class="line">        if (cached != null) &#123;</div><div class="line">            cb.onResourceReady(cached);</div><div class="line">            if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                logWithTimeAndKey(&quot;Loaded resource from cache&quot;, startTime, key);</div><div class="line">            &#125;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        EngineResource&lt;?&gt; active = loadFromActiveResources(key, isMemoryCacheable);</div><div class="line">        if (active != null) &#123;</div><div class="line">            cb.onResourceReady(active);</div><div class="line">            if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                logWithTimeAndKey(&quot;Loaded resource from active resources&quot;, startTime, key);</div><div class="line">            &#125;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        EngineJob current = jobs.get(key);</div><div class="line">        if (current != null) &#123;</div><div class="line">            current.addCallback(cb);</div><div class="line">            if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                logWithTimeAndKey(&quot;Added to existing load&quot;, startTime, key);</div><div class="line">            &#125;</div><div class="line">            return new LoadStatus(cb, current);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        EngineJob engineJob = engineJobFactory.build(key, isMemoryCacheable);</div><div class="line">        DecodeJob&lt;T, Z, R&gt; decodeJob = new DecodeJob&lt;T, Z, R&gt;(key, width, height, fetcher, loadProvider, transformation,</div><div class="line">                transcoder, diskCacheProvider, diskCacheStrategy, priority);</div><div class="line">        EngineRunnable runnable = new EngineRunnable(engineJob, decodeJob, priority);</div><div class="line">        jobs.put(key, engineJob);</div><div class="line">        engineJob.addCallback(cb);</div><div class="line">        engineJob.start(runnable);</div><div class="line"></div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            logWithTimeAndKey(&quot;Started new load&quot;, startTime, key);</div><div class="line">        &#125;</div><div class="line">        return new LoadStatus(cb, engineJob);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>load() 方法中的代码虽然有点长，但大多数的代码都是在处理缓存的。关于缓存的内容我们会在下一篇文章当中学习，现在只需要从第 45 行看起就行。这里构建了一个 EngineJob，它的主要作用就是用来开启线程的，为后面的异步加载图片做准备。接下来第 46 行创建了一个 DecodeJob 对象，从名字上来看，它好像是用来对图片进行解码的，但实际上它的任务十分繁重，待会我们就知道了。继续往下看，第 48 行创建了一个 EngineRunnable 对象，并且在 51 行调用了 EngineJob 的 start() 方法来运行 EngineRunnable 对象，这实际上就是让 EngineRunnable 的 run() 方法在子线程当中执行了。那么我们现在就可以去看看 EngineRunnable 的 run() 方法里做了些什么，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void run() &#123;</div><div class="line">    if (isCancelled) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    Exception exception = null;</div><div class="line">    Resource&lt;?&gt; resource = null;</div><div class="line">    try &#123;</div><div class="line">        resource = decode();</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            Log.v(TAG, &quot;Exception decoding&quot;, e);</div><div class="line">        &#125;</div><div class="line">        exception = e;</div><div class="line">    &#125;</div><div class="line">    if (isCancelled) &#123;</div><div class="line">        if (resource != null) &#123;</div><div class="line">            resource.recycle();</div><div class="line">        &#125;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    if (resource == null) &#123;</div><div class="line">        onLoadFailed(exception);</div><div class="line">    &#125; else &#123;</div><div class="line">        onLoadComplete(resource);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法中的代码并不多，但我们仍然还是要抓重点。在第 9 行，这里调用了一个 decode() 方法，并且这个方法返回了一个 Resource 对象。看上去所有的逻辑应该都在这个 decode() 方法执行的了，那我们跟进去瞧一瞧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private Resource&lt;?&gt; decode() throws Exception &#123;</div><div class="line">    if (isDecodingFromCache()) &#123;</div><div class="line">        return decodeFromCache();</div><div class="line">    &#125; else &#123;</div><div class="line">        return decodeFromSource();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>decode() 方法中又分了两种情况，从缓存当中去 decode 图片的话就会执行 decodeFromCache()，否则的话就执行 decodeFromSource()。本篇文章中我们不讨论缓存的情况，那么就直接来看 decodeFromSource() 方法的代码吧，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">private Resource&lt;?&gt; decodeFromSource() throws Exception &#123;</div><div class="line">    return decodeJob.decodeFromSource();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里又调用了 DecodeJob 的 decodeFromSource() 方法。刚才已经说了，DecodeJob 的任务十分繁重，我们继续跟进看一看吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">class DecodeJob&lt;A, T, Z&gt; &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    public Resource&lt;Z&gt; decodeFromSource() throws Exception &#123;</div><div class="line">        Resource&lt;T&gt; decoded = decodeSource();</div><div class="line">        return transformEncodeAndTranscode(decoded);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Resource&lt;T&gt; decodeSource() throws Exception &#123;</div><div class="line">        Resource&lt;T&gt; decoded = null;</div><div class="line">        try &#123;</div><div class="line">            long startTime = LogTime.getLogTime();</div><div class="line">            final A data = fetcher.loadData(priority);</div><div class="line">            if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                logWithTimeAndKey(&quot;Fetched data&quot;, startTime);</div><div class="line">            &#125;</div><div class="line">            if (isCancelled) &#123;</div><div class="line">                return null;</div><div class="line">            &#125;</div><div class="line">            decoded = decodeFromSourceData(data);</div><div class="line">        &#125; finally &#123;</div><div class="line">            fetcher.cleanup();</div><div class="line">        &#125;</div><div class="line">        return decoded;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>主要的方法就这些，我都帮大家提取出来了。那么我们先来看一下 decodeFromSource() 方法，其实它的工作分为两部，第一步是调用 decodeSource() 方法来获得一个 Resource 对象，第二步是调用 transformEncodeAndTranscode() 方法来处理这个 Resource 对象。</p>
<p>那么我们先来看第一步，decodeSource() 方法中的逻辑也并不复杂，首先在第 14 行调用了 fetcher.loadData() 方法。那么这个 fetcher 是什么呢？其实就是刚才在 onSizeReady() 方法中得到的 ImageVideoFetcher 对象，这里调用它的 loadData() 方法，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public ImageVideoWrapper loadData(Priority priority) throws Exception &#123;</div><div class="line">    InputStream is = null;</div><div class="line">    if (streamFetcher != null) &#123;</div><div class="line">        try &#123;</div><div class="line">            is = streamFetcher.loadData(priority);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                Log.v(TAG, &quot;Exception fetching input stream, trying ParcelFileDescriptor&quot;, e);</div><div class="line">            &#125;</div><div class="line">            if (fileDescriptorFetcher == null) &#123;</div><div class="line">                throw e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ParcelFileDescriptor fileDescriptor = null;</div><div class="line">    if (fileDescriptorFetcher != null) &#123;</div><div class="line">        try &#123;</div><div class="line">            fileDescriptor = fileDescriptorFetcher.loadData(priority);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                Log.v(TAG, &quot;Exception fetching ParcelFileDescriptor&quot;, e);</div><div class="line">            &#125;</div><div class="line">            if (is == null) &#123;</div><div class="line">                throw e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return new ImageVideoWrapper(is, fileDescriptor);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在 ImageVideoFetcher 的 loadData() 方法的第 6 行，这里又去调用了 streamFetcher.loadData() 方法，那么这个 streamFetcher 是什么呢？自然就是刚才在组装 ImageVideoFetcher 对象时传进来的 HttpUrlFetcher 了。因此这里又会去调用 HttpUrlFetcher 的 loadData() 方法，那么我们继续跟进去瞧一瞧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">public class HttpUrlFetcher implements DataFetcher&lt;InputStream&gt; &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public InputStream loadData(Priority priority) throws Exception &#123;</div><div class="line">        return loadDataWithRedirects(glideUrl.toURL(), 0 /*redirects*/, null /*lastUrl*/, glideUrl.getHeaders());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private InputStream loadDataWithRedirects(URL url, int redirects, URL lastUrl, Map&lt;String, String&gt; headers)</div><div class="line">            throws IOException &#123;</div><div class="line">        if (redirects &gt;= MAXIMUM_REDIRECTS) &#123;</div><div class="line">            throw new IOException(&quot;Too many (&gt; &quot; + MAXIMUM_REDIRECTS + &quot;) redirects!&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            // Comparing the URLs using .equals performs additional network I/O and is generally broken.</div><div class="line">            // See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.</div><div class="line">            try &#123;</div><div class="line">                if (lastUrl != null &amp;&amp; url.toURI().equals(lastUrl.toURI())) &#123;</div><div class="line">                    throw new IOException(&quot;In re-direct loop&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125; catch (URISyntaxException e) &#123;</div><div class="line">                // Do nothing, this is best effort.</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        urlConnection = connectionFactory.build(url);</div><div class="line">        for (Map.Entry&lt;String, String&gt; headerEntry : headers.entrySet()) &#123;</div><div class="line">          urlConnection.addRequestProperty(headerEntry.getKey(), headerEntry.getValue());</div><div class="line">        &#125;</div><div class="line">        urlConnection.setConnectTimeout(2500);</div><div class="line">        urlConnection.setReadTimeout(2500);</div><div class="line">        urlConnection.setUseCaches(false);</div><div class="line">        urlConnection.setDoInput(true);</div><div class="line"></div><div class="line">        // Connect explicitly to avoid errors in decoders if connection fails.</div><div class="line">        urlConnection.connect();</div><div class="line">        if (isCancelled) &#123;</div><div class="line">            return null;</div><div class="line">        &#125;</div><div class="line">        final int statusCode = urlConnection.getResponseCode();</div><div class="line">        if (statusCode / 100 == 2) &#123;</div><div class="line">            return getStreamForSuccessfulRequest(urlConnection);</div><div class="line">        &#125; else if (statusCode / 100 == 3) &#123;</div><div class="line">            String redirectUrlString = urlConnection.getHeaderField(&quot;Location&quot;);</div><div class="line">            if (TextUtils.isEmpty(redirectUrlString)) &#123;</div><div class="line">                throw new IOException(&quot;Received empty or null redirect url&quot;);</div><div class="line">            &#125;</div><div class="line">            URL redirectUrl = new URL(url, redirectUrlString);</div><div class="line">            return loadDataWithRedirects(redirectUrl, redirects + 1, url, headers);</div><div class="line">        &#125; else &#123;</div><div class="line">            if (statusCode == -1) &#123;</div><div class="line">                throw new IOException(&quot;Unable to retrieve response code from HttpUrlConnection.&quot;);</div><div class="line">            &#125;</div><div class="line">            throw new IOException(&quot;Request failed &quot; + statusCode + &quot;: &quot; + urlConnection.getResponseMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private InputStream getStreamForSuccessfulRequest(HttpURLConnection urlConnection)</div><div class="line">            throws IOException &#123;</div><div class="line">        if (TextUtils.isEmpty(urlConnection.getContentEncoding())) &#123;</div><div class="line">            int contentLength = urlConnection.getContentLength();</div><div class="line">            stream = ContentLengthInputStream.obtain(urlConnection.getInputStream(), contentLength);</div><div class="line">        &#125; else &#123;</div><div class="line">            if (Log.isLoggable(TAG, Log.DEBUG)) &#123;</div><div class="line">                Log.d(TAG, &quot;Got non empty content encoding: &quot; + urlConnection.getContentEncoding());</div><div class="line">            &#125;</div><div class="line">            stream = urlConnection.getInputStream();</div><div class="line">        &#125;</div><div class="line">        return stream;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>经过一层一层地跋山涉水，我们终于在这里找到网络通讯的代码了！之前有朋友跟我讲过，说 Glide 的源码实在是太复杂了，甚至连网络请求是在哪里发出去的都找不到。我们也是经过一段一段又一段的代码跟踪，终于把网络请求的代码给找出来了，实在是太不容易了。</p>
<p>不过也别高兴得太早，现在离最终分析完还早着呢。可以看到， loadData() 方法只是返回了一个 InputStream，服务器返回的数据连读都还没开始读呢。所以我们还是要静下心来继续分析，回到刚才 ImageVideoFetcher 的 loadData() 方法中，在这个方法的最后一行，创建了一个 ImageVideoWrapper 对象，并把刚才得到的 InputStream 作为参数传了进去。</p>
<p>然后我们回到再上一层，也就是 DecodeJob 的 decodeSource() 方法当中，在得到了这个 ImageVideoWrapper 对象之后，紧接着又将这个对象传入到了 decodeFromSourceData() 当中，来去解码这个对象。decodeFromSourceData() 方法的代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">private Resource&lt;T&gt; decodeFromSourceData(A data) throws IOException &#123;</div><div class="line">    final Resource&lt;T&gt; decoded;</div><div class="line">    if (diskCacheStrategy.cacheSource()) &#123;</div><div class="line">        decoded = cacheAndDecodeSourceData(data);</div><div class="line">    &#125; else &#123;</div><div class="line">        long startTime = LogTime.getLogTime();</div><div class="line">        decoded = loadProvider.getSourceDecoder().decode(data, width, height);</div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            logWithTimeAndKey(&quot;Decoded from source&quot;, startTime);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return decoded;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在第 7 行调用了 loadProvider.getSourceDecoder().decode() 方法来进行解码。loadProvider 就是刚才在 onSizeReady() 方法中得到的 FixedLoadProvider，而 getSourceDecoder() 得到的则是一个 GifBitmapWrapperResourceDecoder 对象，也就是要调用这个对象的 decode() 方法来对图片进行解码。那么我们来看下 GifBitmapWrapperResourceDecoder 的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">public class GifBitmapWrapperResourceDecoder implements ResourceDecoder&lt;ImageVideoWrapper, GifBitmapWrapper&gt; &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;resource&quot;)</div><div class="line">    // @see ResourceDecoder.decode</div><div class="line">    @Override</div><div class="line">    public Resource&lt;GifBitmapWrapper&gt; decode(ImageVideoWrapper source, int width, int height) throws IOException &#123;</div><div class="line">        ByteArrayPool pool = ByteArrayPool.get();</div><div class="line">        byte[] tempBytes = pool.getBytes();</div><div class="line">        GifBitmapWrapper wrapper = null;</div><div class="line">        try &#123;</div><div class="line">            wrapper = decode(source, width, height, tempBytes);</div><div class="line">        &#125; finally &#123;</div><div class="line">            pool.releaseBytes(tempBytes);</div><div class="line">        &#125;</div><div class="line">        return wrapper != null ? new GifBitmapWrapperResource(wrapper) : null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private GifBitmapWrapper decode(ImageVideoWrapper source, int width, int height, byte[] bytes) throws IOException &#123;</div><div class="line">        final GifBitmapWrapper result;</div><div class="line">        if (source.getStream() != null) &#123;</div><div class="line">            result = decodeStream(source, width, height, bytes);</div><div class="line">        &#125; else &#123;</div><div class="line">            result = decodeBitmapWrapper(source, width, height);</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private GifBitmapWrapper decodeStream(ImageVideoWrapper source, int width, int height, byte[] bytes)</div><div class="line">            throws IOException &#123;</div><div class="line">        InputStream bis = streamFactory.build(source.getStream(), bytes);</div><div class="line">        bis.mark(MARK_LIMIT_BYTES);</div><div class="line">        ImageHeaderParser.ImageType type = parser.parse(bis);</div><div class="line">        bis.reset();</div><div class="line">        GifBitmapWrapper result = null;</div><div class="line">        if (type == ImageHeaderParser.ImageType.GIF) &#123;</div><div class="line">            result = decodeGifWrapper(bis, width, height);</div><div class="line">        &#125;</div><div class="line">        // Decoding the gif may fail even if the type matches.</div><div class="line">        if (result == null) &#123;</div><div class="line">            // We can only reset the buffered InputStream, so to start from the beginning of the stream, we need to</div><div class="line">            // pass in a new source containing the buffered stream rather than the original stream.</div><div class="line">            ImageVideoWrapper forBitmapDecoder = new ImageVideoWrapper(bis, source.getFileDescriptor());</div><div class="line">            result = decodeBitmapWrapper(forBitmapDecoder, width, height);</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private GifBitmapWrapper decodeBitmapWrapper(ImageVideoWrapper toDecode, int width, int height) throws IOException &#123;</div><div class="line">        GifBitmapWrapper result = null;</div><div class="line">        Resource&lt;Bitmap&gt; bitmapResource = bitmapDecoder.decode(toDecode, width, height);</div><div class="line">        if (bitmapResource != null) &#123;</div><div class="line">            result = new GifBitmapWrapper(bitmapResource, null);</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先，在 decode() 方法中，又去调用了另外一个 decode() 方法的重载。然后在第 23 行调用了 decodeStream() 方法，准备从服务器返回的流当中读取数据。decodeStream() 方法中会先从流中读取 2 个字节的数据，来判断这张图是 GIF 图还是普通的静图，如果是 GIF 图就调用 decodeGifWrapper() 方法来进行解码，如果是普通的静图就用调用 decodeBitmapWrapper() 方法来进行解码。这里我们只分析普通静图的实现流程，GIF 图的实现有点过于复杂了，无法在本篇文章当中分析。</p>
<p>然后我们来看一下 decodeBitmapWrapper() 方法，这里在第 52 行调用了 bitmapDecoder.decode() 方法。这个 bitmapDecoder 是一个 ImageVideoBitmapDecoder 对象，那么我们来看一下它的代码，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class ImageVideoBitmapDecoder implements ResourceDecoder&lt;ImageVideoWrapper, Bitmap&gt; &#123;</div><div class="line">    private final ResourceDecoder&lt;InputStream, Bitmap&gt; streamDecoder;</div><div class="line">    private final ResourceDecoder&lt;ParcelFileDescriptor, Bitmap&gt; fileDescriptorDecoder;</div><div class="line"></div><div class="line">    public ImageVideoBitmapDecoder(ResourceDecoder&lt;InputStream, Bitmap&gt; streamDecoder,</div><div class="line">            ResourceDecoder&lt;ParcelFileDescriptor, Bitmap&gt; fileDescriptorDecoder) &#123;</div><div class="line">        this.streamDecoder = streamDecoder;</div><div class="line">        this.fileDescriptorDecoder = fileDescriptorDecoder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Resource&lt;Bitmap&gt; decode(ImageVideoWrapper source, int width, int height) throws IOException &#123;</div><div class="line">        Resource&lt;Bitmap&gt; result = null;</div><div class="line">        InputStream is = source.getStream();</div><div class="line">        if (is != null) &#123;</div><div class="line">            try &#123;</div><div class="line">                result = streamDecoder.decode(is, width, height);</div><div class="line">            &#125; catch (IOException e) &#123;</div><div class="line">                if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">                    Log.v(TAG, &quot;Failed to load image from stream, trying FileDescriptor&quot;, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (result == null) &#123;</div><div class="line">            ParcelFileDescriptor fileDescriptor = source.getFileDescriptor();</div><div class="line">            if (fileDescriptor != null) &#123;</div><div class="line">                result = fileDescriptorDecoder.decode(fileDescriptor, width, height);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码并不复杂，在第 14 行先调用了 source.getStream() 来获取到服务器返回的 InputStream，然后在第 17 行调用 streamDecoder.decode() 方法进行解码。streamDecode 是一个 StreamBitmapDecoder 对象，那么我们再来看这个类的源码，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public class StreamBitmapDecoder implements ResourceDecoder&lt;InputStream, Bitmap&gt; &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    private final Downsampler downsampler;</div><div class="line">    private BitmapPool bitmapPool;</div><div class="line">    private DecodeFormat decodeFormat;</div><div class="line"></div><div class="line">    public StreamBitmapDecoder(Downsampler downsampler, BitmapPool bitmapPool, DecodeFormat decodeFormat) &#123;</div><div class="line">        this.downsampler = downsampler;</div><div class="line">        this.bitmapPool = bitmapPool;</div><div class="line">        this.decodeFormat = decodeFormat;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Resource&lt;Bitmap&gt; decode(InputStream source, int width, int height) &#123;</div><div class="line">        Bitmap bitmap = downsampler.decode(source, bitmapPool, width, height, decodeFormat);</div><div class="line">        return BitmapResource.obtain(bitmap, bitmapPool);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，它的 decode() 方法又去调用了 Downsampler 的 decode() 方法。接下来又到了激动人心的时刻了，Downsampler 的代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line">public abstract class Downsampler implements BitmapDecoder&lt;InputStream&gt; &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Bitmap decode(InputStream is, BitmapPool pool, int outWidth, int outHeight, DecodeFormat decodeFormat) &#123;</div><div class="line">        final ByteArrayPool byteArrayPool = ByteArrayPool.get();</div><div class="line">        final byte[] bytesForOptions = byteArrayPool.getBytes();</div><div class="line">        final byte[] bytesForStream = byteArrayPool.getBytes();</div><div class="line">        final BitmapFactory.Options options = getDefaultOptions();</div><div class="line">        // Use to fix the mark limit to avoid allocating buffers that fit entire images.</div><div class="line">        RecyclableBufferedInputStream bufferedStream = new RecyclableBufferedInputStream(</div><div class="line">                is, bytesForStream);</div><div class="line">        // Use to retrieve exceptions thrown while reading.</div><div class="line">        // TODO(#126): when the framework no longer returns partially decoded Bitmaps or provides a way to determine</div><div class="line">        // if a Bitmap is partially decoded, consider removing.</div><div class="line">        ExceptionCatchingInputStream exceptionStream =</div><div class="line">                ExceptionCatchingInputStream.obtain(bufferedStream);</div><div class="line">        // Use to read data.</div><div class="line">        // Ensures that we can always reset after reading an image header so that we can still attempt to decode the</div><div class="line">        // full image even when the header decode fails and/or overflows our read buffer. See #283.</div><div class="line">        MarkEnforcingInputStream invalidatingStream = new MarkEnforcingInputStream(exceptionStream);</div><div class="line">        try &#123;</div><div class="line">            exceptionStream.mark(MARK_POSITION);</div><div class="line">            int orientation = 0;</div><div class="line">            try &#123;</div><div class="line">                orientation = new ImageHeaderParser(exceptionStream).getOrientation();</div><div class="line">            &#125; catch (IOException e) &#123;</div><div class="line">                if (Log.isLoggable(TAG, Log.WARN)) &#123;</div><div class="line">                    Log.w(TAG, &quot;Cannot determine the image orientation from header&quot;, e);</div><div class="line">                &#125;</div><div class="line">            &#125; finally &#123;</div><div class="line">                try &#123;</div><div class="line">                    exceptionStream.reset();</div><div class="line">                &#125; catch (IOException e) &#123;</div><div class="line">                    if (Log.isLoggable(TAG, Log.WARN)) &#123;</div><div class="line">                        Log.w(TAG, &quot;Cannot reset the input stream&quot;, e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            options.inTempStorage = bytesForOptions;</div><div class="line">            final int[] inDimens = getDimensions(invalidatingStream, bufferedStream, options);</div><div class="line">            final int inWidth = inDimens[0];</div><div class="line">            final int inHeight = inDimens[1];</div><div class="line">            final int degreesToRotate = TransformationUtils.getExifOrientationDegrees(orientation);</div><div class="line">            final int sampleSize = getRoundedSampleSize(degreesToRotate, inWidth, inHeight, outWidth, outHeight);</div><div class="line">            final Bitmap downsampled =</div><div class="line">                    downsampleWithSize(invalidatingStream, bufferedStream, options, pool, inWidth, inHeight, sampleSize,</div><div class="line">                            decodeFormat);</div><div class="line">            // BitmapFactory swallows exceptions during decodes and in some cases when inBitmap is non null, may catch</div><div class="line">            // and log a stack trace but still return a non null bitmap. To avoid displaying partially decoded bitmaps,</div><div class="line">            // we catch exceptions reading from the stream in our ExceptionCatchingInputStream and throw them here.</div><div class="line">            final Exception streamException = exceptionStream.getException();</div><div class="line">            if (streamException != null) &#123;</div><div class="line">                throw new RuntimeException(streamException);</div><div class="line">            &#125;</div><div class="line">            Bitmap rotated = null;</div><div class="line">            if (downsampled != null) &#123;</div><div class="line">                rotated = TransformationUtils.rotateImageExif(downsampled, pool, orientation);</div><div class="line">                if (!downsampled.equals(rotated) &amp;&amp; !pool.put(downsampled)) &#123;</div><div class="line">                    downsampled.recycle();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return rotated;</div><div class="line">        &#125; finally &#123;</div><div class="line">            byteArrayPool.releaseBytes(bytesForOptions);</div><div class="line">            byteArrayPool.releaseBytes(bytesForStream);</div><div class="line">            exceptionStream.release();</div><div class="line">            releaseOptions(options);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Bitmap downsampleWithSize(MarkEnforcingInputStream is, RecyclableBufferedInputStream  bufferedStream,</div><div class="line">            BitmapFactory.Options options, BitmapPool pool, int inWidth, int inHeight, int sampleSize,</div><div class="line">            DecodeFormat decodeFormat) &#123;</div><div class="line">        // Prior to KitKat, the inBitmap size must exactly match the size of the bitmap we&apos;re decoding.</div><div class="line">        Bitmap.Config config = getConfig(is, decodeFormat);</div><div class="line">        options.inSampleSize = sampleSize;</div><div class="line">        options.inPreferredConfig = config;</div><div class="line">        if ((options.inSampleSize == 1 || Build.VERSION_CODES.KITKAT &lt;= Build.VERSION.SDK_INT) &amp;&amp; shouldUsePool(is)) &#123;</div><div class="line">            int targetWidth = (int) Math.ceil(inWidth / (double) sampleSize);</div><div class="line">            int targetHeight = (int) Math.ceil(inHeight / (double) sampleSize);</div><div class="line">            // BitmapFactory will clear out the Bitmap before writing to it, so getDirty is safe.</div><div class="line">            setInBitmap(options, pool.getDirty(targetWidth, targetHeight, config));</div><div class="line">        &#125;</div><div class="line">        return decodeStream(is, bufferedStream, options);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * A method for getting the dimensions of an image from the given InputStream.</div><div class="line">     *</div><div class="line">     * @param is The InputStream representing the image.</div><div class="line">     * @param options The options to pass to</div><div class="line">     *          &#123;@link BitmapFactory#decodeStream(InputStream, android.graphics.Rect,</div><div class="line">     *              BitmapFactory.Options)&#125;.</div><div class="line">     * @return an array containing the dimensions of the image in the form &#123;width, height&#125;.</div><div class="line">     */</div><div class="line">    public int[] getDimensions(MarkEnforcingInputStream is, RecyclableBufferedInputStream bufferedStream,</div><div class="line">            BitmapFactory.Options options) &#123;</div><div class="line">        options.inJustDecodeBounds = true;</div><div class="line">        decodeStream(is, bufferedStream, options);</div><div class="line">        options.inJustDecodeBounds = false;</div><div class="line">        return new int[] &#123; options.outWidth, options.outHeight &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static Bitmap decodeStream(MarkEnforcingInputStream is, RecyclableBufferedInputStream bufferedStream,</div><div class="line">            BitmapFactory.Options options) &#123;</div><div class="line">         if (options.inJustDecodeBounds) &#123;</div><div class="line">             // This is large, but jpeg headers are not size bounded so we need something large enough to minimize</div><div class="line">             // the possibility of not being able to fit enough of the header in the buffer to get the image size so</div><div class="line">             // that we don&apos;t fail to load images. The BufferedInputStream will create a new buffer of 2x the</div><div class="line">             // original size each time we use up the buffer space without passing the mark so this is a maximum</div><div class="line">             // bound on the buffer size, not a default. Most of the time we won&apos;t go past our pre-allocated 16kb.</div><div class="line">             is.mark(MARK_POSITION);</div><div class="line">         &#125; else &#123;</div><div class="line">             // Once we&apos;ve read the image header, we no longer need to allow the buffer to expand in size. To avoid</div><div class="line">             // unnecessary allocations reading image data, we fix the mark limit so that it is no larger than our</div><div class="line">             // current buffer size here. See issue #225.</div><div class="line">             bufferedStream.fixMarkLimit();</div><div class="line">         &#125;</div><div class="line">        final Bitmap result = BitmapFactory.decodeStream(is, null, options);</div><div class="line">        try &#123;</div><div class="line">            if (options.inJustDecodeBounds) &#123;</div><div class="line">                is.reset();</div><div class="line">            &#125;</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            if (Log.isLoggable(TAG, Log.ERROR)) &#123;</div><div class="line">                Log.e(TAG, &quot;Exception loading inDecodeBounds=&quot; + options.inJustDecodeBounds</div><div class="line">                        + &quot; sample=&quot; + options.inSampleSize, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，对服务器返回的 InputStream 的读取，以及对图片的加载全都在这里了。当然这里其实处理了很多的逻辑，包括对图片的压缩，甚至还有旋转、圆角等逻辑处理，但是我们目前只需要关注主线逻辑就行了。decode() 方法执行之后，会返回一个 Bitmap 对象，那么图片在这里其实也就已经被加载出来了，剩下的工作就是如果让这个 Bitmap 显示到界面上，我们继续往下分析。</p>
<p>回到刚才的 StreamBitmapDecoder 当中，你会发现，它的 decode() 方法返回的是一个 Resource<bitmap> 对象。而我们从 Downsampler 中得到的是一个 Bitmap 对象，因此这里在第 18 行又调用了 BitmapResource.obtain() 方法，将 Bitmap 对象包装成了 Resource<bitmap> 对象。代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">public class BitmapResource implements Resource&lt;Bitmap&gt; &#123;</div><div class="line">    private final Bitmap bitmap;</div><div class="line">    private final BitmapPool bitmapPool;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns a new &#123;@link BitmapResource&#125; wrapping the given &#123;@link Bitmap&#125; if the Bitmap is non-null or null if the</div><div class="line">     * given Bitmap is null.</div><div class="line">     *</div><div class="line">     * @param bitmap A Bitmap.</div><div class="line">     * @param bitmapPool A non-null &#123;@link BitmapPool&#125;.</div><div class="line">     */</div><div class="line">    public static BitmapResource obtain(Bitmap bitmap, BitmapPool bitmapPool) &#123;</div><div class="line">        if (bitmap == null) &#123;</div><div class="line">            return null;</div><div class="line">        &#125; else &#123;</div><div class="line">            return new BitmapResource(bitmap, bitmapPool);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public BitmapResource(Bitmap bitmap, BitmapPool bitmapPool) &#123;</div><div class="line">        if (bitmap == null) &#123;</div><div class="line">            throw new NullPointerException(&quot;Bitmap must not be null&quot;);</div><div class="line">        &#125;</div><div class="line">        if (bitmapPool == null) &#123;</div><div class="line">            throw new NullPointerException(&quot;BitmapPool must not be null&quot;);</div><div class="line">        &#125;</div><div class="line">        this.bitmap = bitmap;</div><div class="line">        this.bitmapPool = bitmapPool;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Bitmap get() &#123;</div><div class="line">        return bitmap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int getSize() &#123;</div><div class="line">        return Util.getBitmapByteSize(bitmap);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void recycle() &#123;</div><div class="line">        if (!bitmapPool.put(bitmap)) &#123;</div><div class="line">            bitmap.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></bitmap></bitmap></p>
<p>BitmapResource 的源码也非常简单，经过这样一层包装之后，如果我还需要获取 Bitmap，只需要调用 Resource<bitmap> 的 get() 方法就可以了。</bitmap></p>
<p>然后我们需要一层层继续向上返回，StreamBitmapDecoder 会将值返回到 ImageVideoBitmapDecoder 当中，而 ImageVideoBitmapDecoder 又会将值返回到 GifBitmapWrapperResourceDecoder 的 decodeBitmapWrapper() 方法当中。由于代码隔得有点太远了，我重新把 decodeBitmapWrapper() 方法的代码贴一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private GifBitmapWrapper decodeBitmapWrapper(ImageVideoWrapper toDecode, int width, int height) throws IOException &#123;</div><div class="line">    GifBitmapWrapper result = null;</div><div class="line">    Resource&lt;Bitmap&gt; bitmapResource = bitmapDecoder.decode(toDecode, width, height);</div><div class="line">    if (bitmapResource != null) &#123;</div><div class="line">        result = new GifBitmapWrapper(bitmapResource, null);</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，decodeBitmapWrapper() 方法返回的是一个 GifBitmapWrapper 对象。因此，这里在第 5 行，又将 Resource<bitmap> 封装到了一个 GifBitmapWrapper 对象当中。这个 GifBitmapWrapper 顾名思义，就是既能封装 GIF，又能封装 Bitmap，从而保证了不管是什么类型的图片 Glide 都能从容应对。我们顺便来看下 GifBitmapWrapper 的源码吧，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">public class GifBitmapWrapper &#123;</div><div class="line">    private final Resource&lt;GifDrawable&gt; gifResource;</div><div class="line">    private final Resource&lt;Bitmap&gt; bitmapResource;</div><div class="line"></div><div class="line">    public GifBitmapWrapper(Resource&lt;Bitmap&gt; bitmapResource, Resource&lt;GifDrawable&gt; gifResource) &#123;</div><div class="line">        if (bitmapResource != null &amp;&amp; gifResource != null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Can only contain either a bitmap resource or a gif resource, not both&quot;);</div><div class="line">        &#125;</div><div class="line">        if (bitmapResource == null &amp;&amp; gifResource == null) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Must contain either a bitmap resource or a gif resource&quot;);</div><div class="line">        &#125;</div><div class="line">        this.bitmapResource = bitmapResource;</div><div class="line">        this.gifResource = gifResource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the size of the wrapped resource.</div><div class="line">     */</div><div class="line">    public int getSize() &#123;</div><div class="line">        if (bitmapResource != null) &#123;</div><div class="line">            return bitmapResource.getSize();</div><div class="line">        &#125; else &#123;</div><div class="line">            return gifResource.getSize();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the wrapped &#123;@link Bitmap&#125; resource if it exists, or null.</div><div class="line">     */</div><div class="line">    public Resource&lt;Bitmap&gt; getBitmapResource() &#123;</div><div class="line">        return bitmapResource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the wrapped &#123;@link GifDrawable&#125; resource if it exists, or null.</div><div class="line">     */</div><div class="line">    public Resource&lt;GifDrawable&gt; getGifResource() &#123;</div><div class="line">        return gifResource;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></bitmap></p>
<p>还是比较简单的，就是分别对 gifResource 和 bitmapResource 做了一层封装而已，相信没有什么解释的必要。</p>
<p>然后这个 GifBitmapWrapper 对象会一直向上返回，返回到 GifBitmapWrapperResourceDecoder 最外层的 decode() 方法的时候，会对它再做一次封装，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public Resource&lt;GifBitmapWrapper&gt; decode(ImageVideoWrapper source, int width, int height) throws IOException &#123;</div><div class="line">    ByteArrayPool pool = ByteArrayPool.get();</div><div class="line">    byte[] tempBytes = pool.getBytes();</div><div class="line">    GifBitmapWrapper wrapper = null;</div><div class="line">    try &#123;</div><div class="line">        wrapper = decode(source, width, height, tempBytes);</div><div class="line">    &#125; finally &#123;</div><div class="line">        pool.releaseBytes(tempBytes);</div><div class="line">    &#125;</div><div class="line">    return wrapper != null ? new GifBitmapWrapperResource(wrapper) : null;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在第 11 行，又将 GifBitmapWrapper 封装到了一个 GifBitmapWrapperResource 对象当中，最终返回的是一个 Resource<gifbitmapwrapper> 对象。这个 GifBitmapWrapperResource 和刚才的 BitmapResource 是相似的，它们都实现的 Resource 接口，都可以通过 get() 方法来获取封装起来的具体内容。GifBitmapWrapperResource 的源码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">public class GifBitmapWrapperResource implements Resource&lt;GifBitmapWrapper&gt; &#123;</div><div class="line">    private final GifBitmapWrapper data;</div><div class="line"></div><div class="line">    public GifBitmapWrapperResource(GifBitmapWrapper data) &#123;</div><div class="line">        if (data == null) &#123;</div><div class="line">            throw new NullPointerException(&quot;Data must not be null&quot;);</div><div class="line">        &#125;</div><div class="line">        this.data = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public GifBitmapWrapper get() &#123;</div><div class="line">        return data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int getSize() &#123;</div><div class="line">        return data.getSize();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void recycle() &#123;</div><div class="line">        Resource&lt;Bitmap&gt; bitmapResource = data.getBitmapResource();</div><div class="line">        if (bitmapResource != null) &#123;</div><div class="line">            bitmapResource.recycle();</div><div class="line">        &#125;</div><div class="line">        Resource&lt;GifDrawable&gt; gifDataResource = data.getGifResource();</div><div class="line">        if (gifDataResource != null) &#123;</div><div class="line">            gifDataResource.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></gifbitmapwrapper></p>
<p>经过这一层的封装之后，我们从网络上得到的图片就能够以 Resource 接口的形式返回，并且还能同时处理 Bitmap 图片和 GIF 图片这两种情况。</p>
<p>那么现在我们可以回到 DecodeJob 当中了，它的 decodeFromSourceData() 方法返回的是一个 Resource<t> 对象，其实也就是 Resource<gifbitmapwrapper> 对象了。然后继续向上返回，最终返回到 decodeFromSource() 方法当中，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public Resource&lt;Z&gt; decodeFromSource() throws Exception &#123;</div><div class="line">    Resource&lt;T&gt; decoded = decodeSource();</div><div class="line">    return transformEncodeAndTranscode(decoded);</div><div class="line">&#125;</div></pre></td></tr></table></figure></gifbitmapwrapper></t></p>
<p>刚才我们就是从这里跟进到 decodeSource() 方法当中，然后执行了一大堆一大堆的逻辑，最终得到了这个 Resource<t> 对象。然而你会发现，decodeFromSource() 方法最终返回的却是一个 Resource<z> 对象，那么这到底是怎么回事呢？我们就需要跟进到 transformEncodeAndTranscode() 方法来瞧一瞧了，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">private Resource&lt;Z&gt; transformEncodeAndTranscode(Resource&lt;T&gt; decoded) &#123;</div><div class="line">    long startTime = LogTime.getLogTime();</div><div class="line">    Resource&lt;T&gt; transformed = transform(decoded);</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logWithTimeAndKey(&quot;Transformed resource from source&quot;, startTime);</div><div class="line">    &#125;</div><div class="line">    writeTransformedToCache(transformed);</div><div class="line">    startTime = LogTime.getLogTime();</div><div class="line">    Resource&lt;Z&gt; result = transcode(transformed);</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logWithTimeAndKey(&quot;Transcoded transformed from source&quot;, startTime);</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private Resource&lt;Z&gt; transcode(Resource&lt;T&gt; transformed) &#123;</div><div class="line">    if (transformed == null) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">    return transcoder.transcode(transformed);</div><div class="line">&#125;</div></pre></td></tr></table></figure></z></t></p>
<p>首先，这个方法开头的几行transform还有cache，这都是我们后面才会学习的东西，现在不用管它们就可以了。需要注意的是第9行，这里调用了一个transcode()方法，就把Resource<t>对象转换成Resource<z>对象了。</z></t></p>
<p>而 transcode() 方法中又是调用了 transcoder 的 transcode() 方法，那么这个 transcoder 是什么呢？其实这也是 Glide 源码特别难懂的原因之一，就是它用到的很多对象都是很早很早之前就初始化的，在初始化的时候你可能完全就没有留意过它，因为一时半会根本就用不着，但是真正需要用到的时候你却早就记不起来这个对象是从哪儿来的了。</p>
<p>那么这里我来提醒一下大家吧，在第二步 load() 方法返回的那个 DrawableTypeRequest 对象，它的构建函数中去构建了一个 FixedLoadProvider 对象，然后我们将三个参数传入到了 FixedLoadProvider 当中，其中就有一个 GifBitmapWrapperDrawableTranscoder 对象。后来在 onSizeReady() 方法中获取到了这个参数，并传递到了 Engine 当中，然后又由 Engine 传递到了 DecodeJob 当中。因此，这里的 transcoder 其实就是这个 GifBitmapWrapperDrawableTranscoder 对象。那么我们来看一下它的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class GifBitmapWrapperDrawableTranscoder implements ResourceTranscoder&lt;GifBitmapWrapper, GlideDrawable&gt; &#123;</div><div class="line">    private final ResourceTranscoder&lt;Bitmap, GlideBitmapDrawable&gt; bitmapDrawableResourceTranscoder;</div><div class="line"></div><div class="line">    public GifBitmapWrapperDrawableTranscoder(</div><div class="line">            ResourceTranscoder&lt;Bitmap, GlideBitmapDrawable&gt; bitmapDrawableResourceTranscoder) &#123;</div><div class="line">        this.bitmapDrawableResourceTranscoder = bitmapDrawableResourceTranscoder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Resource&lt;GlideDrawable&gt; transcode(Resource&lt;GifBitmapWrapper&gt; toTranscode) &#123;</div><div class="line">        GifBitmapWrapper gifBitmap = toTranscode.get();</div><div class="line">        Resource&lt;Bitmap&gt; bitmapResource = gifBitmap.getBitmapResource();</div><div class="line">        final Resource&lt;? extends GlideDrawable&gt; result;</div><div class="line">        if (bitmapResource != null) &#123;</div><div class="line">            result = bitmapDrawableResourceTranscoder.transcode(bitmapResource);</div><div class="line">        &#125; else &#123;</div><div class="line">            result = gifBitmap.getGifResource();</div><div class="line">        &#125;</div><div class="line">        return (Resource&lt;GlideDrawable&gt;) result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我来简单解释一下，GifBitmapWrapperDrawableTranscoder 的核心作用就是用来转码的。因为 GifBitmapWrapper 是无法直接显示到 ImageView 上面的，只有 Bitmap 或者 Drawable 才能显示到 ImageView 上。因此，这里的 transcode() 方法先从 Resource<gifbitmapwrapper> 中取出 GifBitmapWrapper 对象，然后再从 GifBitmapWrapper 中取出 Resource<bitmap> 对象。</bitmap></gifbitmapwrapper></p>
<p>接下来做了一个判断，如果 Resource<bitmap> 为空，那么说明此时加载的是 GIF 图，直接调用 getGifResource() 方法将图片取出即可，因为 Glide 用于加载 GIF 图片是使用的 GifDrawable 这个类，它本身就是一个 Drawable 对象了。而如果 Resource<bitmap> 不为空，那么就需要再做一次转码，将 Bitmap 转换成 Drawable 对象才行，因为要保证静图和动图的类型一致性，不然逻辑上是不好处理的。</bitmap></bitmap></p>
<p>这里在第 15 行又进行了一次转码，是调用的 GlideBitmapDrawableTranscoder 对象的 transcode() 方法，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class GlideBitmapDrawableTranscoder implements ResourceTranscoder&lt;Bitmap, GlideBitmapDrawable&gt; &#123;</div><div class="line">    private final Resources resources;</div><div class="line">    private final BitmapPool bitmapPool;</div><div class="line"></div><div class="line">    public GlideBitmapDrawableTranscoder(Context context) &#123;</div><div class="line">        this(context.getResources(), Glide.get(context).getBitmapPool());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public GlideBitmapDrawableTranscoder(Resources resources, BitmapPool bitmapPool) &#123;</div><div class="line">        this.resources = resources;</div><div class="line">        this.bitmapPool = bitmapPool;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Resource&lt;GlideBitmapDrawable&gt; transcode(Resource&lt;Bitmap&gt; toTranscode) &#123;</div><div class="line">        GlideBitmapDrawable drawable = new GlideBitmapDrawable(resources, toTranscode.get());</div><div class="line">        return new GlideBitmapDrawableResource(drawable, bitmapPool);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里 new 出了一个 GlideBitmapDrawable 对象，并把 Bitmap 封装到里面。然后对 GlideBitmapDrawable 再进行一次封装，返回一个 Resource<glidebitmapdrawable> 对象。</glidebitmapdrawable></p>
<p>现在再返回到 GifBitmapWrapperDrawableTranscoder 的 transcode() 方法中，你会发现它们的类型就一致了。因为不管是静图的 Resource<glidebitmapdrawable> 对象，还是动图的 Resource<gifdrawable> 对象，它们都是属于父类 Resource<glidedrawable> 对象的。因此 transcode() 方法也是直接返回了 Resource<glidedrawable>，而这个 Resource<glidedrawable> 其实也就是转换过后的 Resource<z>了。</z></glidedrawable></glidedrawable></glidedrawable></gifdrawable></glidebitmapdrawable></p>
<p>那么我们继续回到 DecodeJob当中，它的 decodeFromSource() 方法得到了 Resource<z> 对象，当然也就是 Resource<glidedrawable> 对象。然后继续向上返回会回到 EngineRunnable 的 decodeFromSource() 方法，再回到 decode() 方法，再回到 run() 方法当中。那么我们重新再贴一下 EngineRunnable run() 方法的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void run() &#123;</div><div class="line">    if (isCancelled) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    Exception exception = null;</div><div class="line">    Resource&lt;?&gt; resource = null;</div><div class="line">    try &#123;</div><div class="line">        resource = decode();</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            Log.v(TAG, &quot;Exception decoding&quot;, e);</div><div class="line">        &#125;</div><div class="line">        exception = e;</div><div class="line">    &#125;</div><div class="line">    if (isCancelled) &#123;</div><div class="line">        if (resource != null) &#123;</div><div class="line">            resource.recycle();</div><div class="line">        &#125;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    if (resource == null) &#123;</div><div class="line">        onLoadFailed(exception);</div><div class="line">    &#125; else &#123;</div><div class="line">        onLoadComplete(resource);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></glidedrawable></z></p>
<p>也就是说，经过第 9 行 decode() 方法的执行，我们最终得到了这个 Resource<glidedrawable> 对象，那么接下来就是如何将它显示出来了。可以看到，这里在第 25 行调用了 onLoadComplete() 方法，表示图片加载已经完成了，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">private void onLoadComplete(Resource resource) &#123;</div><div class="line">    manager.onResourceReady(resource);</div><div class="line">&#125;</div></pre></td></tr></table></figure></glidedrawable></p>
<p>这个 manager 就是 EngineJob 对象，因此这里实际上调用的是 EngineJob 的 onResourceReady() 方法，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">class EngineJob implements EngineRunnable.EngineRunnableManager &#123;</div><div class="line"></div><div class="line">    private static final Handler MAIN_THREAD_HANDLER = new Handler(Looper.getMainLooper(), new MainThreadCallback());</div><div class="line"></div><div class="line">    private final List&lt;ResourceCallback&gt; cbs = new ArrayList&lt;ResourceCallback&gt;();</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    public void addCallback(ResourceCallback cb) &#123;</div><div class="line">        Util.assertMainThread();</div><div class="line">        if (hasResource) &#123;</div><div class="line">            cb.onResourceReady(engineResource);</div><div class="line">        &#125; else if (hasException) &#123;</div><div class="line">            cb.onException(exception);</div><div class="line">        &#125; else &#123;</div><div class="line">            cbs.add(cb);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onResourceReady(final Resource&lt;?&gt; resource) &#123;</div><div class="line">        this.resource = resource;</div><div class="line">        MAIN_THREAD_HANDLER.obtainMessage(MSG_COMPLETE, this).sendToTarget();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void handleResultOnMainThread() &#123;</div><div class="line">        if (isCancelled) &#123;</div><div class="line">            resource.recycle();</div><div class="line">            return;</div><div class="line">        &#125; else if (cbs.isEmpty()) &#123;</div><div class="line">            throw new IllegalStateException(&quot;Received a resource without any callbacks to notify&quot;);</div><div class="line">        &#125;</div><div class="line">        engineResource = engineResourceFactory.build(resource, isCacheable);</div><div class="line">        hasResource = true;</div><div class="line">        engineResource.acquire();</div><div class="line">        listener.onEngineJobComplete(key, engineResource);</div><div class="line">        for (ResourceCallback cb : cbs) &#123;</div><div class="line">            if (!isInIgnoredCallbacks(cb)) &#123;</div><div class="line">                engineResource.acquire();</div><div class="line">                cb.onResourceReady(engineResource);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        engineResource.release();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onException(final Exception e) &#123;</div><div class="line">        this.exception = e;</div><div class="line">        MAIN_THREAD_HANDLER.obtainMessage(MSG_EXCEPTION, this).sendToTarget();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void handleExceptionOnMainThread() &#123;</div><div class="line">        if (isCancelled) &#123;</div><div class="line">            return;</div><div class="line">        &#125; else if (cbs.isEmpty()) &#123;</div><div class="line">            throw new IllegalStateException(&quot;Received an exception without any callbacks to notify&quot;);</div><div class="line">        &#125;</div><div class="line">        hasException = true;</div><div class="line">        listener.onEngineJobComplete(key, null);</div><div class="line">        for (ResourceCallback cb : cbs) &#123;</div><div class="line">            if (!isInIgnoredCallbacks(cb)) &#123;</div><div class="line">                cb.onException(exception);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class MainThreadCallback implements Handler.Callback &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public boolean handleMessage(Message message) &#123;</div><div class="line">            if (MSG_COMPLETE == message.what || MSG_EXCEPTION == message.what) &#123;</div><div class="line">                EngineJob job = (EngineJob) message.obj;</div><div class="line">                if (MSG_COMPLETE == message.what) &#123;</div><div class="line">                    job.handleResultOnMainThread();</div><div class="line">                &#125; else &#123;</div><div class="line">                    job.handleExceptionOnMainThread();</div><div class="line">                &#125;</div><div class="line">                return true;</div><div class="line">            &#125;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在 onResourceReady() 方法使用 Handler 发出了一条 MSG_COMPLETE 消息，那么在 MainThreadCallback 的 handleMessage() 方法中就会收到这条消息。从这里开始，所有的逻辑又回到主线程当中进行了，因为很快就需要更新 UI 了。</p>
<p>然后在第 72 行调用了 handleResultOnMainThread() 方法，这个方法中又通过一个循环，调用了所有 ResourceCallback 的 onResourceReady() 方法。那么这个 ResourceCallback 是什么呢？答案在 addCallback() 方法当中，它会向 cbs 集合中去添加 ResourceCallback。那么这个 addCallback() 方法又是哪里调用的呢？其实调用的地方我们早就已经看过了，只不过之前没有注意，现在重新来看一下 Engine 的 load() 方法，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public class Engine implements EngineJobListener,</div><div class="line">        MemoryCache.ResourceRemovedListener,</div><div class="line">        EngineResource.ResourceListener &#123;</div><div class="line"></div><div class="line">    ...    </div><div class="line"></div><div class="line">    public &lt;T, Z, R&gt; LoadStatus load(Key signature, int width, int height, DataFetcher&lt;T&gt; fetcher,</div><div class="line">            DataLoadProvider&lt;T, Z&gt; loadProvider, Transformation&lt;Z&gt; transformation, ResourceTranscoder&lt;Z, R&gt; transcoder, Priority priority, </div><div class="line">            boolean isMemoryCacheable, DiskCacheStrategy diskCacheStrategy, ResourceCallback cb) &#123;</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">        EngineJob engineJob = engineJobFactory.build(key, isMemoryCacheable);</div><div class="line">        DecodeJob&lt;T, Z, R&gt; decodeJob = new DecodeJob&lt;T, Z, R&gt;(key, width, height, fetcher, loadProvider, transformation,</div><div class="line">                transcoder, diskCacheProvider, diskCacheStrategy, priority);</div><div class="line">        EngineRunnable runnable = new EngineRunnable(engineJob, decodeJob, priority);</div><div class="line">        jobs.put(key, engineJob);</div><div class="line">        engineJob.addCallback(cb);</div><div class="line">        engineJob.start(runnable);</div><div class="line"></div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            logWithTimeAndKey(&quot;Started new load&quot;, startTime, key);</div><div class="line">        &#125;</div><div class="line">        return new LoadStatus(cb, engineJob);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这次把目光放在第 18 行上面，看到了吗？就是在这里调用的 EngineJob 的 addCallback() 方法来注册的一个 ResourceCallback。那么接下来的问题就是，Engine.load() 方法的 ResourceCallback 参数又是谁传过来的呢？这就需要回到 GenericRequest 的 onSizeReady() 方法当中了，我们看到 ResourceCallback 是 load() 方法的最后一个参数，那么在 onSizeReady() 方法中调用 load() 方法时传入的最后一个参数是什么？代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">public final class GenericRequest&lt;A, T, Z, R&gt; implements Request, SizeReadyCallback,</div><div class="line">        ResourceCallback &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onSizeReady(int width, int height) &#123;</div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            logV(&quot;Got onSizeReady in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">        &#125;</div><div class="line">        if (status != Status.WAITING_FOR_SIZE) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        status = Status.RUNNING;</div><div class="line">        width = Math.round(sizeMultiplier * width);</div><div class="line">        height = Math.round(sizeMultiplier * height);</div><div class="line">        ModelLoader&lt;A, T&gt; modelLoader = loadProvider.getModelLoader();</div><div class="line">        final DataFetcher&lt;T&gt; dataFetcher = modelLoader.getResourceFetcher(model, width, height);</div><div class="line">        if (dataFetcher == null) &#123;</div><div class="line">            onException(new Exception(&quot;Failed to load model: \&apos;&quot; + model + &quot;\&apos;&quot;));</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        ResourceTranscoder&lt;Z, R&gt; transcoder = loadProvider.getTranscoder();</div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            logV(&quot;finished setup for calling load in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">        &#125;</div><div class="line">        loadedFromMemoryCache = true;</div><div class="line">        loadStatus = engine.load(signature, width, height, dataFetcher, loadProvider, transformation, </div><div class="line">                transcoder, priority, isMemoryCacheable, diskCacheStrategy, this);</div><div class="line">        loadedFromMemoryCache = resource != null;</div><div class="line">        if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">            logV(&quot;finished onSizeReady in &quot; + LogTime.getElapsedMillis(startTime));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>请将目光锁定在第 29 行的最后一个参数，this。没错，就是 this。GenericRequest 本身就实现了 ResourceCallback 的接口，因此 EngineJob 的回调最终其实就是回调到了 GenericRequest 的 onResourceReady() 方法当中了，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">public void onResourceReady(Resource&lt;?&gt; resource) &#123;</div><div class="line">    if (resource == null) &#123;</div><div class="line">        onException(new Exception(&quot;Expected to receive a Resource&lt;R&gt; with an object of &quot; + transcodeClass</div><div class="line">                + &quot; inside, but instead got null.&quot;));</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    Object received = resource.get();</div><div class="line">    if (received == null || !transcodeClass.isAssignableFrom(received.getClass())) &#123;</div><div class="line">        releaseResource(resource);</div><div class="line">        onException(new Exception(&quot;Expected to receive an object of &quot; + transcodeClass</div><div class="line">                + &quot; but instead got &quot; + (received != null ? received.getClass() : &quot;&quot;) + &quot;&#123;&quot; + received + &quot;&#125;&quot;</div><div class="line">                + &quot; inside Resource&#123;&quot; + resource + &quot;&#125;.&quot;</div><div class="line">                + (received != null ? &quot;&quot; : &quot; &quot;</div><div class="line">                    + &quot;To indicate failure return a null Resource object, &quot;</div><div class="line">                    + &quot;rather than a Resource object containing null data.&quot;)</div><div class="line">        ));</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    if (!canSetResource()) &#123;</div><div class="line">        releaseResource(resource);</div><div class="line">        // We can&apos;t set the status to complete before asking canSetResource().</div><div class="line">        status = Status.COMPLETE;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    onResourceReady(resource, (R) received);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void onResourceReady(Resource&lt;?&gt; resource, R result) &#123;</div><div class="line">    // We must call isFirstReadyResource before setting status.</div><div class="line">    boolean isFirstResource = isFirstReadyResource();</div><div class="line">    status = Status.COMPLETE;</div><div class="line">    this.resource = resource;</div><div class="line">    if (requestListener == null || !requestListener.onResourceReady(result, model, target, loadedFromMemoryCache,</div><div class="line">            isFirstResource)) &#123;</div><div class="line">        GlideAnimation&lt;R&gt; animation = animationFactory.build(loadedFromMemoryCache, isFirstResource);</div><div class="line">        target.onResourceReady(result, animation);</div><div class="line">    &#125;</div><div class="line">    notifyLoadSuccess();</div><div class="line">    if (Log.isLoggable(TAG, Log.VERBOSE)) &#123;</div><div class="line">        logV(&quot;Resource ready in &quot; + LogTime.getElapsedMillis(startTime) + &quot; size: &quot;</div><div class="line">                + (resource.getSize() * TO_MEGABYTE) + &quot; fromCache: &quot; + loadedFromMemoryCache);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里有两个 onResourceReady() 方法，首先在第一个 onResourceReady() 方法当中，调用 resource.get() 方法获取到了封装的图片对象，也就是 GlideBitmapDrawable 对象，或者是 GifDrawable 对象。然后将这个值传入到了第二个 onResourceReady() 方法当中，并在第 36 行调用了 target.onResourceReady() 方法。</p>
<p>那么这个 target 又是什么呢？这个又需要向上翻很久了，在第三步 into() 方法的一开始，我们就分析了在 into() 方法的最后一行，调用了 glide.buildImageViewTarget() 方法来构建出一个 Target，而这个 Target 就是一个 GlideDrawableImageViewTarget 对象。</p>
<p>那么我们去看 GlideDrawableImageViewTarget 的源码就可以了，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">public class GlideDrawableImageViewTarget extends ImageViewTarget&lt;GlideDrawable&gt; &#123;</div><div class="line">    private static final float SQUARE_RATIO_MARGIN = 0.05f;</div><div class="line">    private int maxLoopCount;</div><div class="line">    private GlideDrawable resource;</div><div class="line"></div><div class="line">    public GlideDrawableImageViewTarget(ImageView view) &#123;</div><div class="line">        this(view, GlideDrawable.LOOP_FOREVER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public GlideDrawableImageViewTarget(ImageView view, int maxLoopCount) &#123;</div><div class="line">        super(view);</div><div class="line">        this.maxLoopCount = maxLoopCount;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onResourceReady(GlideDrawable resource, GlideAnimation&lt;? super GlideDrawable&gt; animation) &#123;</div><div class="line">        if (!resource.isAnimated()) &#123;</div><div class="line">            float viewRatio = view.getWidth() / (float) view.getHeight();</div><div class="line">            float drawableRatio = resource.getIntrinsicWidth() / (float) resource.getIntrinsicHeight();</div><div class="line">            if (Math.abs(viewRatio - 1f) &lt;= SQUARE_RATIO_MARGIN</div><div class="line">                    &amp;&amp; Math.abs(drawableRatio - 1f) &lt;= SQUARE_RATIO_MARGIN) &#123;</div><div class="line">                resource = new SquaringDrawable(resource, view.getWidth());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        super.onResourceReady(resource, animation);</div><div class="line">        this.resource = resource;</div><div class="line">        resource.setLoopCount(maxLoopCount);</div><div class="line">        resource.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void setResource(GlideDrawable resource) &#123;</div><div class="line">        view.setImageDrawable(resource);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onStart() &#123;</div><div class="line">        if (resource != null) &#123;</div><div class="line">            resource.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onStop() &#123;</div><div class="line">        if (resource != null) &#123;</div><div class="line">            resource.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 GlideDrawableImageViewTarget 的 onResourceReady() 方法中做了一些逻辑处理，包括如果是 GIF 图片的话，就调用 resource.start() 方法开始播放图片，但是好像并没有看到哪里有将 GlideDrawable 显示到 ImageView 上的逻辑。</p>
<p>确实没有，不过父类里面有，这里在第 25 行调用了 super.onResourceReady() 方法，GlideDrawableImageViewTarget 的父类是 ImageViewTarget，我们来看下它的代码吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public abstract class ImageViewTarget&lt;Z&gt; extends ViewTarget&lt;ImageView, Z&gt; implements GlideAnimation.ViewAdapter &#123;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onResourceReady(Z resource, GlideAnimation&lt;? super Z&gt; glideAnimation) &#123;</div><div class="line">        if (glideAnimation == null || !glideAnimation.animate(resource, this)) &#123;</div><div class="line">            setResource(resource);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    protected abstract void setResource(Z resource);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，在 ImageViewTarget 的 onResourceReady() 方法当中调用了 setResource() 方法，而 ImageViewTarget 的 setResource() 方法是一个抽象方法，具体的实现还是在子类那边实现的。</p>
<p>那子类的 setResource() 方法是怎么实现的呢？回头再来看一下 GlideDrawableImageViewTarget 的 setResource() 方法，没错，调用的 view.setImageDrawable() 方法，而这个 view 就是 ImageView。代码执行到这里，图片终于也就显示出来了。</p>
<p>那么，我们对 Glide 执行流程的源码分析，到这里也终于结束了。</p>
<p>真是好长的一篇文章，这也可能是我目前所写过的最长的一篇文章了。如果你之前没有读过 Glide 的源码，真的很难相信，这短短一行代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Glide.with(this).load(url).into(imageView);</div></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/FRAMEWORK/" rel="tag"><i class="fa fa-tag"></i> FRAMEWORK</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/1902/01/07/07 THIRD PARY FRAMEWORK/11 Glide 快速入门/" rel="next" title="11 Glide 快速入门">
                <i class="fa fa-chevron-left"></i> 11 Glide 快速入门
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/1902/01/09/07 THIRD PARY FRAMEWORK/13 Glide 缓存机制/" rel="prev" title="13 Glide 缓存机制">
                13 Glide 缓存机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="先小涛" />
            
              <p class="site-author-name" itemprop="name">先小涛</p>
              <p class="site-description motion-element" itemprop="description">我至诚我道</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">160</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xianxiaotao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/9fe7b66d2982" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-globe"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xianxiaotao@icloud.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.google.cn/reference?hl=en" title="ANDROID API" target="_blank">ANDROID API</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.iconfont.cn/" title="ICON" target="_blank">ICON</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#with"><span class="nav-text">with()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#load"><span class="nav-text">load()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#into"><span class="nav-text">into()</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">先小涛</span>

  
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共381.9k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'rbnnUjJovf4WCIErS35Hwons-gzGzoHsz',
        appKey: 'ywF5FLP3tubCiWyrJoxH7gJq',
        placeholder: 'ヾﾉ≧∀≦)o 来呀！快活呀！',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
