<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="FRAMEWORK," />





  <link rel="alternate" href="/atom.xml" title="先小涛" type="application/atom+xml" />






<meta name="description" content="项目地址：https://github.com/bumptech/glide官方文档：http://bumptech.github.io/glide/中文文档：https://muyangmin.github.io/glide-docs-cn/原文链接：https://blog.csdn.net/guolin_blog/article/details/70215985·文章目录：Glide">
<meta property="og:type" content="article">
<meta property="og:title" content="14 Glide 回调与监听">
<meta property="og:url" content="http://yoursite.com/1902/01/10/07 THIRD PARY FRAMEWORK/14 Glide 回调与监听/index.html">
<meta property="og:site_name" content="先小涛">
<meta property="og:description" content="项目地址：https://github.com/bumptech/glide官方文档：http://bumptech.github.io/glide/中文文档：https://muyangmin.github.io/glide-docs-cn/原文链接：https://blog.csdn.net/guolin_blog/article/details/70215985·文章目录：Glide">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/14186083-bed48fbccfad4aa9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://img-blog.csdn.net/20170615212142394">
<meta property="og:image" content="https://img-blog.csdn.net/20170615225048126">
<meta property="og:image" content="https://img-blog.csdn.net/20170616223448840">
<meta property="og:image" content="https://img-blog.csdn.net/20170616223618749">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/14186083-4a93fa43cd391629.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2020-04-04T04:24:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="14 Glide 回调与监听">
<meta name="twitter:description" content="项目地址：https://github.com/bumptech/glide官方文档：http://bumptech.github.io/glide/中文文档：https://muyangmin.github.io/glide-docs-cn/原文链接：https://blog.csdn.net/guolin_blog/article/details/70215985·文章目录：Glide">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/14186083-bed48fbccfad4aa9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/1902/01/10/07 THIRD PARY FRAMEWORK/14 Glide 回调与监听/"/>





  <title>14 Glide 回调与监听 | 先小涛</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/xianxiaotao" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">先小涛</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我至诚我道</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/1902/01/10/07 THIRD PARY FRAMEWORK/14 Glide 回调与监听/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="先小涛">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="先小涛">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">14 Glide 回调与监听</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="1902-01-10T00:00:00+08:00">
                1902-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FRAMEWORK/" itemprop="url" rel="index">
                    <span itemprop="name">FRAMEWORK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/1902/01/10/07 THIRD PARY FRAMEWORK/14 Glide 回调与监听/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/1902/01/10/07 THIRD PARY FRAMEWORK/14 Glide 回调与监听/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <meta name="referrer" content="no-referrer">

<blockquote>
<p>项目地址：<a href="https://github.com/bumptech/glide" target="_blank" rel="external">https://github.com/bumptech/glide</a><br>官方文档：<a href="http://bumptech.github.io/glide/" target="_blank" rel="external">http://bumptech.github.io/glide/</a><br>中文文档：<a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="external">https://muyangmin.github.io/glide-docs-cn/</a><br>原文链接：<a href="https://blog.csdn.net/guolin_blog/article/details/70215985" target="_blank" rel="external">https://blog.csdn.net/guolin_blog/article/details/70215985</a><br>·<br>文章目录：<br><a href="">Glide 快速入门</a><br><a href="">Glide 源码分析执行流程</a><br><a href="">Glide 缓存机制</a><br><a href="">Glide 回调与监听</a></p>
</blockquote>
<h3 id="回调的源码实现"><a href="#回调的源码实现" class="headerlink" title="回调的源码实现"></a>回调的源码实现</h3><p>作为一名 Glide 老手，相信大家对于 Glide 的基本用法已经非常熟练了。我们都知道，使用 Glide 在界面上加载并展示一张图片只需要一行代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Glide.with(this).load(url).into(imageView);</div></pre></td></tr></table></figure></p>
<p>而在这一行代码的背后，Glide 帮我们执行了成千上万行的逻辑。其实在第二篇文章当中，我们已经分析了这一行代码背后的完整执行流程，但是这里我准备再带着大家单独回顾一下回调这部分的源码，这将有助于我们今天这篇文章的学习。</p>
<p>首先来看一下 into() 方法，这里我们将 ImageView 的实例传入到 into() 方法当中，Glide 将图片加载完成之后，图片就能显示到 ImageView 上了。这是怎么实现的呢？我们来看一下 into() 方法的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public Target&lt;TranscodeType&gt; into(ImageView view) &#123;</div><div class="line">    Util.assertMainThread();</div><div class="line">    if (view == null) &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;You must pass in a non null View&quot;);</div><div class="line">    &#125;</div><div class="line">    if (!isTransformationSet &amp;&amp; view.getScaleType() != null) &#123;</div><div class="line">        switch (view.getScaleType()) &#123;</div><div class="line">            case CENTER_CROP:</div><div class="line">                applyCenterCrop();</div><div class="line">                break;</div><div class="line">            case FIT_CENTER:</div><div class="line">            case FIT_START:</div><div class="line">            case FIT_END:</div><div class="line">                applyFitCenter();</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                // Do nothing.</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return into(glide.buildImageViewTarget(view, transcodeClass));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，最后一行代码会调用 glide.buildImageViewTarget() 方法构建出一个 Target 对象，然后再把它传入到另一个接收 Target 参数的 into() 方法中。Target 对象则是用来最终展示图片用的，如果我们跟进到 glide.buildImageViewTarget() 方法中，你会看到如下的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class ImageViewTargetFactory &#123;</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    public &lt;Z&gt; Target&lt;Z&gt; buildTarget(ImageView view, Class&lt;Z&gt; clazz) &#123;</div><div class="line">        if (GlideDrawable.class.isAssignableFrom(clazz)) &#123;</div><div class="line">            return (Target&lt;Z&gt;) new GlideDrawableImageViewTarget(view);</div><div class="line">        &#125; else if (Bitmap.class.equals(clazz)) &#123;</div><div class="line">            return (Target&lt;Z&gt;) new BitmapImageViewTarget(view);</div><div class="line">        &#125; else if (Drawable.class.isAssignableFrom(clazz)) &#123;</div><div class="line">            return (Target&lt;Z&gt;) new DrawableImageViewTarget(view);</div><div class="line">        &#125; else &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Unhandled class: &quot; + clazz</div><div class="line">                    + &quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>buildTarget() 方法会根据传入的 class 参数来构建不同的 Target 对象，如果你在使用 Glide 加载图片的时候调用了 asBitmap() 方法，那么这里就会构建出 BitmapImageViewTarget 对象，否则的话构建的都是 GlideDrawableImageViewTarget 对象。至于上述代码中的 DrawableImageViewTarget 对象，这个通常都是用不到的，我们可以暂时不用管它。</p>
<p>之后就会把这里构建出来的 Target 对象传入到 GenericRequest 当中，而 Glide 在图片加载完成之后又会回调 GenericRequest 的 onResourceReady() 方法，我们来看一下这部分源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public final class GenericRequest&lt;A, T, Z, R&gt; implements Request, SizeReadyCallback,</div><div class="line">        ResourceCallback &#123;</div><div class="line"></div><div class="line">    private Target&lt;R&gt; target;</div><div class="line">    ...</div><div class="line"></div><div class="line">    private void onResourceReady(Resource&lt;?&gt; resource, R result) &#123;</div><div class="line">        boolean isFirstResource = isFirstReadyResource();</div><div class="line">        status = Status.COMPLETE;</div><div class="line">        this.resource = resource;</div><div class="line">        if (requestListener == null || !requestListener.onResourceReady(result, model, target,</div><div class="line">                loadedFromMemoryCache, isFirstResource)) &#123;</div><div class="line">            GlideAnimation&lt;R&gt; animation = animationFactory.build(loadedFromMemoryCache, isFirstResource);</div><div class="line">            target.onResourceReady(result, animation);</div><div class="line">        &#125;</div><div class="line">        notifyLoadSuccess();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里在第 14 行 调用了 target.onResourceReady() 方法，而刚才我们已经知道，这里的 target 就是 GlideDrawableImageViewTarget 对象，那么我们再来看一下它的源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">public class GlideDrawableImageViewTarget extends ImageViewTarget&lt;GlideDrawable&gt; &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onResourceReady(GlideDrawable resource, GlideAnimation&lt;? super GlideDrawable&gt; animation) &#123;</div><div class="line">        if (!resource.isAnimated()) &#123;</div><div class="line">            float viewRatio = view.getWidth() / (float) view.getHeight();</div><div class="line">            float drawableRatio = resource.getIntrinsicWidth() / (float) resource.getIntrinsicHeight();</div><div class="line">            if (Math.abs(viewRatio - 1f) &lt;= SQUARE_RATIO_MARGIN</div><div class="line">                    &amp;&amp; Math.abs(drawableRatio - 1f) &lt;= SQUARE_RATIO_MARGIN) &#123;</div><div class="line">                resource = new SquaringDrawable(resource, view.getWidth());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        super.onResourceReady(resource, animation);</div><div class="line">        this.resource = resource;</div><div class="line">        resource.setLoopCount(maxLoopCount);</div><div class="line">        resource.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void setResource(GlideDrawable resource) &#123;</div><div class="line">        view.setImageDrawable(resource);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在 onResourceReady() 方法中处理了图片展示，还有 GIF 播放的逻辑，那么一张图片也就显示出来了，这也就是 Glide 回调的基本实现原理。</p>
<p>好的，那么原理就先分析到这儿，接下来我们就来看一下在回调和监听方面还有哪些知识是可以扩展的。</p>
<h3 id="into"><a href="#into" class="headerlink" title="into()"></a>into()</h3><p>使用了这么久的 Glide，我们都知道 into() 方法中是可以传入 ImageView 的。那么 into() 方法还可以传入别的参数吗？我可以让 Glide 加载出来的图片不显示到 ImageView 上吗？答案是肯定的，这就需要用到自定义 Target 功能。</p>
<p>其实通过上面的分析，我们已经知道了，into() 方法还有一个接收 Target 参数的重载。即使我们传入的参数是 ImageView，Glide也会在内部自动构建一个 Target 对象。而如果我们能够掌握自定义 Target 技术的话，就可以更加随心所欲地控制 Glide 的回调了。</p>
<p>我们先来看一下 Glide 中 Target 的继承结构图吧，如下所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14186083-bed48fbccfad4aa9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>可以看到，Target 的继承结构还是相当复杂的，实现 Target 接口的子类非常多。不过你不用被这么多的子类所吓到，这些大多数都是 Glide 已经实现好的具备完整功能的 Target 子类，如果我们要进行自定义的话，通常只需要在两种 Target 的基础上去自定义就可以了，一种是 SimpleTarget，一种是 ViewTarget。</p>
<p>接下来我就分别以这两种 Target 来举例，学习一下自定义 Target 的功能。</p>
<p>首先来看 SimpleTarget，顾名思义，它是一种极为简单的 Target，我们使用它可以将 Glide 加载出来的图片对象获取到，而不是像之前那样只能将图片在 ImageView 上显示出来。</p>
<p>那么下面我们来看一下 SimpleTarget 的用法示例吧，其实非常简单：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">SimpleTarget&lt;GlideDrawable&gt; simpleTarget = new SimpleTarget&lt;GlideDrawable&gt;() &#123;</div><div class="line">    @Override</div><div class="line">    public void onResourceReady(GlideDrawable resource, GlideAnimation glideAnimation) &#123;</div><div class="line">        imageView.setImageDrawable(resource);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">public void loadImage(View view) &#123;</div><div class="line">    String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">    Glide.with(this)</div><div class="line">         .load(url)</div><div class="line">         .into(simpleTarget);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>怎么样？不愧是 SimpleTarget 吧，短短几行代码就搞了。这里我们创建了一个 SimpleTarget 的实例，并且指定它的泛型是 GlideDrawable，然后重写了 onResourceReady() 方法。在 onResourceReady() 方法中，我们就可以获取到 Glide 加载出来的图片对象了，也就是方法参数中传过来的 GlideDrawable 对象。有了这个对象之后你可以使用它进行任意的逻辑操作，这里我只是简单地把它显示到了 ImageView 上。</p>
<p>SimpleTarget 的实现创建好了，那么只需要在加载图片的时候将它传入到 into() 方法中就可以了，现在运行一下程序，效果如下图所示。</p>
<p><img src="https://img-blog.csdn.net/20170615212142394" alt=""></p>
<p>虽然目前这个效果和直接在 into() 方法中传入 ImageView 并没有什么区别，但是我们已经拿到了图片对象的实例，然后就可以随意做更多的事情了。</p>
<p>当然，SimpleTarget 中的泛型并不一定只能是 GlideDrawable，如果你能确定你正在加载的是一张静态图而不是 GIF 图的话，我们还能直接拿到这张图的 Bitmap 对象，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">SimpleTarget&lt;Bitmap&gt; simpleTarget = new SimpleTarget&lt;Bitmap&gt;() &#123;</div><div class="line">    @Override</div><div class="line">    public void onResourceReady(Bitmap resource, GlideAnimation glideAnimation) &#123;</div><div class="line">        imageView.setImageBitmap(resource);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">public void loadImage(View view) &#123;</div><div class="line">    String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">    Glide.with(this)</div><div class="line">         .load(url)</div><div class="line">         .asBitmap()</div><div class="line">         .into(simpleTarget);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里我们将 SimpleTarget 的泛型指定成 Bitmap，然后在加载图片的时候调用了 asBitmap() 方法强制指定这是一张静态图，这样就能在 onResourceReady() 方法中获取到这张图的 Bitmap 对象了。</p>
<p>好了，SimpleTarget 的用法就是这么简单，接下来我们学习一下 ViewTarget 的用法。</p>
<p>事实上，从刚才的继承结构图上就能看出，Glide 在内部自动帮我们创建的 GlideDrawableImageViewTarget 就是 ViewTarget 的子类。只不过 GlideDrawableImageViewTarget 被限定只能作用在 ImageView 上，而 ViewTarget 的功能更加广泛，它可以作用在任意的 View 上。</p>
<p>这里我们还是通过一个例子来演示一下吧，比如我创建了一个自定义布局 MyLayout，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class MyLayout extends LinearLayout &#123;</div><div class="line"></div><div class="line">    private ViewTarget&lt;MyLayout, GlideDrawable&gt; viewTarget;</div><div class="line"></div><div class="line">    public MyLayout(Context context, AttributeSet attrs) &#123;</div><div class="line">        super(context, attrs);</div><div class="line">        viewTarget = new ViewTarget&lt;MyLayout, GlideDrawable&gt;(this) &#123;</div><div class="line">            @Override</div><div class="line">            public void onResourceReady(GlideDrawable resource, GlideAnimation glideAnimation) &#123;</div><div class="line">                MyLayout myLayout = getView();</div><div class="line">                myLayout.setImageAsBackground(resource);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ViewTarget&lt;MyLayout, GlideDrawable&gt; getTarget() &#123;</div><div class="line">        return viewTarget;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setImageAsBackground(GlideDrawable resource) &#123;</div><div class="line">        setBackground(resource);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 MyLayout 的构造函数中，我们创建了一个 ViewTarget 的实例，并将 Mylayout 当前的实例 this 传了进去。ViewTarget 中需要指定两个泛型，一个是 View 的类型，一个图片的类型（GlideDrawable或Bitmap）。然后在 onResourceReady() 方法中，我们就可以通过 getView() 方法获取到 MyLayout 的实例，并调用它的任意接口了。比如说这里我们调用了 setImageAsBackground() 方法来将加载出来的图片作为 MyLayout 布局的背景图。</p>
<p>接下来看一下怎么使用这个 Target 吧，由于 MyLayout 中已经提供了 getTarget() 接口，我们只需要在加载图片的地方这样写就可以了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends AppCompatActivity &#123;</div><div class="line"></div><div class="line">    MyLayout myLayout;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        myLayout = (MyLayout) findViewById(R.id.background);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void loadImage(View view) &#123;</div><div class="line">        String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">        Glide.with(this)</div><div class="line">             .load(url)</div><div class="line">             .into(myLayout.getTarget());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就是这么简单，在 into() 方法中传入 myLayout.getTarget() 即可。现在重新运行一下程序，效果如下图所示。</p>
<p><img src="https://img-blog.csdn.net/20170615225048126" alt=""></p>
<p>好的，关于自定义 Target 的功能我们就介绍这么多，这些虽说都是自定义 Target 最基本的用法，但掌握了这些用法之后，你就能应对各种各样复杂的逻辑了。</p>
<h3 id="preload"><a href="#preload" class="headerlink" title="preload()"></a>preload()</h3><p>Glide 加载图片虽说非常智能，它会自动判断该图片是否已经有缓存了，如果有的话就直接从缓存中读取，没有的话再从网络去下载。但是如果我希望提前对图片进行一个预加载，等真正需要加载图片的时候就直接从缓存中读取，不想再等待慢长的网络加载时间了，这该怎么办呢？</p>
<p>对于很多 Glide 新手来说这确实是一个烦恼的问题，因为在没有学习本篇文章之前，into() 方法中必须传入一个 ImageView 呀，而传了 ImageView 之后图片就显示出来了，这还怎么预加载呢？</p>
<p>不过在学习了本篇文章之后，相信你已经能够想到解决方案了。因为 into() 方法中除了传入 ImageView 之后还可以传入 Target 对象，如果我们在 Target 对象的 onResourceReady() 方法中做一个空实现，也就是不做任何逻辑处理，那么图片自然也就显示不出来了，而 Glide 的缓存机制却仍然还会正常工作，这样不就实现预加载功能了吗？</p>
<p>没错，上述的做法完全可以实现预加载功能，不过有没有感觉这种实现方式有点笨笨的。事实上，Glide 专门给我们提供了预加载的接口，也就是 preload() 方法，我们只需要直接使用就可以了。</p>
<p>preload() 方法有两个方法重载，一个不带参数，表示将会加载图片的原始尺寸，另一个可以通过参数指定加载图片的宽和高。</p>
<p>preload() 方法的用法也非常简单，直接使用它来替换 into() 方法即可，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Glide.with(this)</div><div class="line">     .load(url)</div><div class="line">     .diskCacheStrategy(DiskCacheStrategy.SOURCE)</div><div class="line">     .preload();</div></pre></td></tr></table></figure></p>
<p>需要注意的是，我们如果使用了 preload() 方法，最好要将 diskCacheStrategy 的缓存策略指定成 DiskCacheStrategy.SOURCE。因为 preload() 方法默认是预加载的原始图片大小，而 into() 方法则默认会根据 ImageView 控件的大小来动态决定加载图片的大小。因此，如果不将 diskCacheStrategy 的缓存策略指定成 DiskCacheStrategy.SOURCE 的话，很容易会造成我们在预加载完成之后再使用 into() 方法加载图片，却仍然还是要从网络上去请求图片这种现象。</p>
<p>调用了预加载之后，我们以后想再去加载这张图片就会非常快了，因为 Glide 会直接从缓存当中去读取图片并显示出来，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Glide.with(this)</div><div class="line">     .load(url)</div><div class="line">     .diskCacheStrategy(DiskCacheStrategy.SOURCE)</div><div class="line">     .into(imageView);</div></pre></td></tr></table></figure></p>
<p>注意，这里我们仍然需要使用 diskCacheStrategy() 方法将硬盘缓存策略指定成 DiskCacheStrategy.SOURCE，以保证 Glide 一定会去读取刚才预加载的图片缓存。</p>
<p>preload()方法的用法大概就是这么简单，但是仅仅会使用显然层次有些太低了，下面我们就满足一下好奇心，看看它的源码是如何实现的。</p>
<p>和 into() 方法一样，preload() 方法也是在 GenericRequestBuilder 类当中的，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; implements Cloneable &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    public Target&lt;TranscodeType&gt; preload(int width, int height) &#123;</div><div class="line">        final PreloadTarget&lt;TranscodeType&gt; target = PreloadTarget.obtain(width, height);</div><div class="line">        return into(target);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Target&lt;TranscodeType&gt; preload() &#123;</div><div class="line">        return preload(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>正如刚才所说，preload() 方法有两个方法重载，你可以调用带参数的 preload() 方法来明确指定图片的宽和高，也可以调用不带参数的 preload() 方法，它会在内部自动将图片的宽和高都指定成 Target.SIZE_ORIGINAL，也就是图片的原始尺寸。</p>
<p>然后我们可以看到，这里在第 5 行调用了 PreloadTarget.obtain() 方法获取一个 PreloadTarget 的实例，并把它传入到了 into() 方法当中。从刚才的继承结构图中可以看出，PreloadTarget 是 SimpleTarget 的子类，因此它是可以直接传入到 into() 方法中的。</p>
<p>那么现在的问题就是，PreloadTarget 具体的实现到底是什么样子的了，我们看一下它的源码，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public final class PreloadTarget&lt;Z&gt; extends SimpleTarget&lt;Z&gt; &#123;</div><div class="line"></div><div class="line">    public static &lt;Z&gt; PreloadTarget&lt;Z&gt; obtain(int width, int height) &#123;</div><div class="line">        return new PreloadTarget&lt;Z&gt;(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private PreloadTarget(int width, int height) &#123;</div><div class="line">        super(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onResourceReady(Z resource, GlideAnimation&lt;? super Z&gt; glideAnimation) &#123;</div><div class="line">        Glide.clear(this);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>PreloadTarget 的源码非常简单，obtain() 方法中就是 new 了一个 PreloadTarget 的实例而已，而 onResourceReady() 方法中也没做什么事情，只是调用了 Glide.clear() 方法。</p>
<p>这里的 Glide.clear() 并不是清空缓存的意思，而是表示加载已完成，释放资源的意思，因此不用在这里产生疑惑。</p>
<p>其实 PreloadTarget 的思想和我们刚才提到设计思路是一样的，就是什么都不做就可以了。因为图片加载完成之后只将它缓存而不去显示它，那不就相当于预加载了嘛。</p>
<p>preload() 方法不管是在用法方面还是源码实现方面都还是非常简单的，那么关于这个方法我们就学到这里。</p>
<h3 id="downloadOnly"><a href="#downloadOnly" class="headerlink" title="downloadOnly()"></a>downloadOnly()</h3><p>一直以来，我们使用 Glide 都是为了将图片显示到界面上。虽然我们知道 Glide 会在图片的加载过程中对图片进行缓存，但是缓存文件到底是存在哪里的，以及如何去直接访问这些缓存文件？我们都还不知道。</p>
<p>其实 Glide 将图片加载接口设计成这样也是希望我们使用起来更加的方便，不用过多去考虑底层的实现细节。但如果我现在就是想要去访问图片的缓存文件该怎么办呢？这就需要用到 downloadOnly() 方法了。</p>
<p>和 preload() 方法类似，downloadOnly() 方法也是可以替换 into() 方法的，不过 downloadOnly() 方法的用法明显要比 preload() 方法复杂不少。顾名思义，downloadOnly() 方法表示只会下载图片，而不会对图片进行加载。当图片下载完成之后，我们可以得到图片的存储路径，以便后续进行操作。</p>
<p>那么首先我们还是先来看下基本用法。downloadOnly() 方法是定义在 DrawableTypeRequest 类当中的，它有两个方法重载，一个接收图片的宽度和高度，另一个接收一个泛型对象，如下所示：<br>· downloadOnly(int width, int height)<br>· downloadOnly(Y target)</p>
<p>这两个方法各自有各自的应用场景，其中 downloadOnly(int width, int height) 是用于在子线程中下载图片的，而 downloadOnly(Y target) 是用于在主线程中下载图片的。</p>
<p>那么我们先来看 downloadOnly(int width, int height) 的用法。当调用了 downloadOnly(int width, int height) 方法后会立即返回一个 FutureTarget 对象，然后 Glide 会在后台开始下载图片文件。接下来我们调用 FutureTarget 的 get() 方法就可以去获取下载好的图片文件了，如果此时图片还没有下载完，那么 get() 方法就会阻塞住，一直等到图片下载完成才会有值返回。</p>
<p>下面我们通过一个例子来演示一下吧，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public void downloadImage(View view) &#123;</div><div class="line">    new Thread(new Runnable() &#123;</div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            try &#123;</div><div class="line">                String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">                final Context context = getApplicationContext();</div><div class="line">                FutureTarget&lt;File&gt; target = Glide.with(context)</div><div class="line">                                                 .load(url)</div><div class="line">                                                 .downloadOnly(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL);</div><div class="line">                final File imageFile = target.get();</div><div class="line">                runOnUiThread(new Runnable() &#123;</div><div class="line">                    @Override</div><div class="line">                    public void run() &#123;</div><div class="line">                        Toast.makeText(context, imageFile.getPath(), Toast.LENGTH_LONG).show();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;).start();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码稍微有一点点长，我带着大家解读一下。首先刚才说了，downloadOnly(int width, int height) 方法必须要用在子线程当中，因此这里的第一步就是 new 了一个 Thread。在子线程当中，我们先获取了一个 Application Context，这个时候不能再用 Activity 作为 Context 了，因为会有 Activity 销毁了但子线程还没执行完这种可能出现。</p>
<p>接下来就是 Glide 的基本用法，只不过将 into() 方法替换成了 downloadOnly() 方法。downloadOnly() 方法会返回一个 FutureTarget 对象，这个时候其实 Glide 已经开始在后台下载图片了，我们随时都可以调用 FutureTarget 的 get() 方法来获取下载的图片文件，只不过如果图片还没下载好线程会暂时阻塞住，等下载完成了才会把图片的 File 对象返回。</p>
<p>最后，我们使用 runOnUiThread() 切回到主线程，然后使用 Toast 将下载好的图片文件路径显示出来。</p>
<p>现在重新运行一下代码，效果如下图所示。</p>
<p><img src="https://img-blog.csdn.net/20170616223448840" alt=""></p>
<p>这样我们就能清晰地看出来图片完整的缓存路径是什么了。</p>
<p>之后我们可以使用如下代码去加载这张图片，图片就会立即显示出来，而不用再去网络上请求了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void loadImage(View view) &#123;</div><div class="line">    String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">    Glide.with(this)</div><div class="line">            .load(url)</div><div class="line">            .diskCacheStrategy(DiskCacheStrategy.SOURCE)</div><div class="line">            .into(imageView);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要注意的是，这里必须将硬盘缓存策略指定成 DiskCacheStrategy.SOURCE 或者 DiskCacheStrategy.ALL，否则 Glide 将无法使用我们刚才下载好的图片缓存文件。</p>
<p>现在重新运行一下代码，效果如下图所示。</p>
<p><img src="https://img-blog.csdn.net/20170616223618749" alt=""></p>
<p>可以看到，图片的加载和显示是非常快的，因为 Glide 直接使用的是刚才下载好的缓存文件。</p>
<p>那么这个 downloadOnly(int width, int height) 方法的工作原理到底是什么样的呢？我们来简单快速地看一下它的源码吧。</p>
<p>首先在 DrawableTypeRequest 类当中可以找到定义这个方法的地方，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class DrawableTypeRequest&lt;ModelType&gt; extends DrawableRequestBuilder&lt;ModelType&gt;</div><div class="line">        implements DownloadOptions &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    public FutureTarget&lt;File&gt; downloadOnly(int width, int height) &#123;</div><div class="line">        return getDownloadOnlyRequest().downloadOnly(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private GenericTranscodeRequest&lt;ModelType, InputStream, File&gt; getDownloadOnlyRequest() &#123;</div><div class="line">        return optionsApplier.apply(new GenericTranscodeRequest&lt;ModelType, InputStream, File&gt;(</div><div class="line">            File.class, this, streamModelLoader, InputStream.class, File.class, optionsApplier));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里会先调用 getDownloadOnlyRequest() 方法得到一个 GenericTranscodeRequest 对象，然后再调用它的 downloadOnly() 方法，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class GenericTranscodeRequest&lt;ModelType, DataType, ResourceType&gt;</div><div class="line">    implements DownloadOptions &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    public FutureTarget&lt;File&gt; downloadOnly(int width, int height) &#123;</div><div class="line">        return getDownloadOnlyRequest().into(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private GenericRequestBuilder&lt;ModelType, DataType, File, File&gt; getDownloadOnlyRequest() &#123;</div><div class="line">        ResourceTranscoder&lt;File, File&gt; transcoder = UnitTranscoder.get();</div><div class="line">        DataLoadProvider&lt;DataType, File&gt; dataLoadProvider = glide.buildDataProvider(dataClass, File.class);</div><div class="line">        FixedLoadProvider&lt;ModelType, DataType, File, File&gt; fixedLoadProvider =</div><div class="line">            new FixedLoadProvider&lt;ModelType, DataType, File, File&gt;(modelLoader, transcoder, dataLoadProvider);</div><div class="line">        return optionsApplier.apply(</div><div class="line">                new GenericRequestBuilder&lt;ModelType, DataType, File, File&gt;(fixedLoadProvider,</div><div class="line">                File.class, this))</div><div class="line">                .priority(Priority.LOW)</div><div class="line">                .diskCacheStrategy(DiskCacheStrategy.SOURCE)</div><div class="line">                .skipMemoryCache(true);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里又是调用了一个 getDownloadOnlyRequest() 方法来构建了一个图片下载的请求，getDownloadOnlyRequest() 方法会返回一个 GenericRequestBuilder 对象，接着调用它的 into(width, height) 方法，我们继续跟进去瞧一瞧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public FutureTarget&lt;TranscodeType&gt; into(int width, int height) &#123;</div><div class="line">    final RequestFutureTarget&lt;ModelType, TranscodeType&gt; target =</div><div class="line">            new RequestFutureTarget&lt;ModelType, TranscodeType&gt;(glide.getMainHandler(), width, height);</div><div class="line">    glide.getMainHandler().post(new Runnable() &#123;</div><div class="line">        @Override</div><div class="line">        public void run() &#123;</div><div class="line">            if (!target.isCancelled()) &#123;</div><div class="line">                into(target);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    return target;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里首先是 new 出了一个 RequestFutureTarget 对象，RequestFutureTarget 也是 Target 的子类之一。然后通过 Handler 将线程切回到主线程当中，再将这个 RequestFutureTarget 传入到 into() 方法当中。</p>
<p>那么也就是说，其实这里就是调用了接收 Target 参数的 into() 方法，然后 Glide 就开始执行正常的图片加载逻辑了。那么现在剩下的问题就是，这个 RequestFutureTarget 中到底处理了些什么逻辑？我们打开它的源码看一看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">public class RequestFutureTarget&lt;T, R&gt; implements FutureTarget&lt;R&gt;, Runnable &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public R get() throws InterruptedException, ExecutionException &#123;</div><div class="line">        try &#123;</div><div class="line">            return doGet(null);</div><div class="line">        &#125; catch (TimeoutException e) &#123;</div><div class="line">            throw new AssertionError(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public R get(long time, TimeUnit timeUnit) throws InterruptedException, ExecutionException, </div><div class="line">        TimeoutException &#123;</div><div class="line">        return doGet(timeUnit.toMillis(time));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void getSize(SizeReadyCallback cb) &#123;</div><div class="line">        cb.onSizeReady(width, height);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public synchronized void onLoadFailed(Exception e, Drawable errorDrawable) &#123;</div><div class="line">        exceptionReceived = true;</div><div class="line">        this.exception = e;</div><div class="line">        waiter.notifyAll(this);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public synchronized void onResourceReady(R resource, GlideAnimation&lt;? super R&gt; glideAnimation) &#123;</div><div class="line">        resultReceived = true;</div><div class="line">        this.resource = resource;</div><div class="line">        waiter.notifyAll(this);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private synchronized R doGet(Long timeoutMillis) throws ExecutionException, InterruptedException, </div><div class="line">        TimeoutException &#123;</div><div class="line">        if (assertBackgroundThread) &#123;</div><div class="line">            Util.assertBackgroundThread();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (isCancelled) &#123;</div><div class="line">            throw new CancellationException();</div><div class="line">        &#125; else if (exceptionReceived) &#123;</div><div class="line">            throw new ExecutionException(exception);</div><div class="line">        &#125; else if (resultReceived) &#123;</div><div class="line">            return resource;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (timeoutMillis == null) &#123;</div><div class="line">            waiter.waitForTimeout(this, 0);</div><div class="line">        &#125; else if (timeoutMillis &gt; 0) &#123;</div><div class="line">            waiter.waitForTimeout(this, timeoutMillis);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (Thread.interrupted()) &#123;</div><div class="line">            throw new InterruptedException();</div><div class="line">        &#125; else if (exceptionReceived) &#123;</div><div class="line">            throw new ExecutionException(exception);</div><div class="line">        &#125; else if (isCancelled) &#123;</div><div class="line">            throw new CancellationException();</div><div class="line">        &#125; else if (!resultReceived) &#123;</div><div class="line">            throw new TimeoutException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return resource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static class Waiter &#123;</div><div class="line"></div><div class="line">        public void waitForTimeout(Object toWaitOn, long timeoutMillis) throws InterruptedException &#123;</div><div class="line">            toWaitOn.wait(timeoutMillis);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void notifyAll(Object toNotify) &#123;</div><div class="line">            toNotify.notifyAll();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我对 RequestFutureTarget 的源码做了一些精简，我们只看最主要的逻辑就可以了。</p>
<p>刚才我们已经学习过了 downloadOnly() 方法的基本用法，在调用了 downloadOnly() 方法之后，再调用 FutureTarget 的 get() 方法，就能获取到下载的图片文件了。而 downloadOnly() 方法返回的 FutureTarget 对象其实就是这个 RequestFutureTarget，因此我们直接来看它的 get() 方法就行了。</p>
<p>RequestFutureTarget 的 get() 方法中又调用了一个 doGet() 方法，而 doGet() 方法才是真正处理具体逻辑的地方。首先在 doGet() 方法中会判断当前是否是在子线程当中，如果不是的话会直接抛出一个异常。然后下面会判断下载是否已取消、或者已失败，如果是已取消或者已失败的话都会直接抛出一个异常。接下来会根据 resultReceived 这个变量来判断下载是否已完成，如果这个变量为 true 的话，就直接把结果进行返回。</p>
<p>那么如果下载还没有完成呢？我们继续往下看，接下来就进入到一个 wait() 当中，把当前线程给阻塞住，从而阻止代码继续往下执行。这也是为什么 downloadOnly(int width, int height) 方法要求必须在子线程当中使用，因为它会对当前线程进行阻塞，如果在主线程当中使用的话，那么就会让主线程卡死，从而用户无法进行任何其他操作。</p>
<p>那么现在线程被阻塞住了，什么时候才能恢复呢？答案在 onResourceReady() 方法中。可以看到，onResourceReady() 方法中只有三行代码，第一行把 resultReceived 赋值成 true，说明图片文件已经下载好了，这样下次再调用 get() 方法时就不会再阻塞线程，而是可以直接将结果返回。第二行把下载好的图片文件赋值到一个全局的 resource 变量上面，这样 doGet() 方法就也可以访问到它。第三行 notifyAll 一下，通知所有 wait 的线程取消阻塞，这个时候图片文件已经下载好了，因此 doGet() 方法也就可以返回结果了。</p>
<p>好的，这就是 downloadOnly(int width, int height) 方法的基本用法和实现原理，那么下面我们来看一下 downloadOnly(Y target) 方法。</p>
<p>回想一下，其实 downloadOnly(int width, int height) 方法必须使用在子线程当中，最主要还是因为它在内部帮我们自动创建了一个 RequestFutureTarget，是这个 RequestFutureTarget 要求必须在子线程当中执行。而 downloadOnly(Y target) 方法则要求我们传入一个自己创建的 Target，因此就不受 RequestFutureTarget 的限制了。</p>
<p>但是 downloadOnly(Y target) 方法的用法也会相对更复杂一些，因为我们又要自己创建一个 Target 了，而且这次必须直接去实现最顶层的 Target 接口，比之前的 SimpleTarget 和 ViewTarget 都要复杂不少。</p>
<p>那么下面我们就来实现一个最简单的 DownloadImageTarget 吧，注意 Target 接口的泛型必须指定成 File 对象，这是 downloadOnly(Y target) 方法要求的，代码如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">public class DownloadImageTarget implements Target&lt;File&gt; &#123;</div><div class="line"></div><div class="line">    private static final String TAG = &quot;DownloadImageTarget&quot;;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onStart() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onStop() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onDestroy() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onLoadStarted(Drawable placeholder) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onLoadFailed(Exception e, Drawable errorDrawable) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onResourceReady(File resource, GlideAnimation&lt;? super File&gt; glideAnimation) &#123;</div><div class="line">        Log.d(TAG, resource.getPath());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onLoadCleared(Drawable placeholder) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void getSize(SizeReadyCallback cb) &#123;</div><div class="line">        cb.onSizeReady(Target.SIZE_ORIGINAL, Target.SIZE_ORIGINAL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void setRequest(Request request) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Request getRequest() &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于是要直接实现 Target 接口，因此需要重写的方法非常多。这些方法大多是数 Glide 加载图片生命周期的一些回调，我们可以不用管它们，其中只有两个方法是必须实现的，一个是 getSize() 方法，一个是 onResourceReady() 方法。</p>
<p>在第二篇 Glide 源码解析的时候，我带着大家一起分析过，Glide 在开始加载图片之前会先计算图片的大小，然后回调到 onSizeReady() 方法当中，之后才会开始执行图片加载。而这里，计算图片大小的任务就交给我们了。只不过这是一个最简单的 Target 实现，我在 getSize() 方法中就直接回调了 Target.SIZE_ORIGINAL，表示图片的原始尺寸。</p>
<p>然后 onResourceReady() 方法我们就非常熟悉了，图片下载完成之后就会回调到这里，我在这个方法中只是打印了一下下载的图片文件的路径。</p>
<p>这样一个最简单的 DownloadImageTarget 就定义好了，使用它也非常的简单，我们不用再考虑什么线程的问题了，而是直接把它的实例传入 downloadOnly(Y target) 方法中即可，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public void downloadImage(View view) &#123;</div><div class="line">    String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">    Glide.with(this)</div><div class="line">            .load(url)</div><div class="line">            .downloadOnly(new DownloadImageTarget());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在重新运行一下代码并点击 Download Image 按钮，然后观察控制台日志的输出，结果如下图所示。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14186083-4a93fa43cd391629.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这样我们就使用了 downloadOnly(Y target) 方法同样获取到下载的图片文件的缓存路径了。</p>
<p>好的，那么关于 downloadOnly() 方法我们就学到这里。</p>
<h3 id="listener"><a href="#listener" class="headerlink" title="listener()"></a>listener()</h3><p>今天学习的内容已经够多了，下面我们就以一个简单的知识点结尾吧，Glide 回调与监听的最后一部分——listener() 方法。</p>
<p>其实 listener() 方法的作用非常普遍，它可以用来监听 Glide 加载图片的状态。举个例子，比如说我们刚才使用了 preload() 方法来对图片进行预加载，但是我怎样确定预加载有没有完成呢？还有如果 Glide 加载图片失败了，我该怎样调试错误的原因呢？答案都在 listener() 方法当中。</p>
<p>首先来看下 listener() 方法的基本用法吧，不同于刚才几个方法都是要替换 into() 方法的，listener() 是结合 into() 方法一起使用的，当然也可以结合 preload() 方法一起使用。最基本的用法如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public void loadImage(View view) &#123;</div><div class="line">    String url = &quot;http://cn.bing.com/az/hprichbg/rb/TOAD_ZH-CN7336795473_1920x1080.jpg&quot;;</div><div class="line">    Glide.with(this)</div><div class="line">            .load(url)</div><div class="line">            .listener(new RequestListener&lt;String, GlideDrawable&gt;() &#123;</div><div class="line">                @Override</div><div class="line">                public boolean onException(Exception e, String model, Target&lt;GlideDrawable&gt; target,</div><div class="line">                    boolean isFirstResource) &#123;</div><div class="line">                    return false;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                @Override</div><div class="line">                public boolean onResourceReady(GlideDrawable resource, String model,</div><div class="line">                    Target&lt;GlideDrawable&gt; target, boolean isFromMemoryCache, boolean isFirstResource) &#123;</div><div class="line">                    return false;</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .into(imageView);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们在 into() 方法之前串接了一个 listener() 方法，然后实现了一个 RequestListener 的实例。其中 RequestListener 需要实现两个方法，一个 onResourceReady() 方法，一个 onException() 方法。从方法名上就可以看出来了，当图片加载完成的时候就会回调 onResourceReady() 方法，而当图片加载失败的时候就会回调 onException() 方法，onException() 方法中会将失败的 Exception 参数传进来，这样我们就可以定位具体失败的原因了。</p>
<p>没错，listener() 方法就是这么简单。不过还有一点需要处理，onResourceReady() 方法和 onException() 方法都有一个布尔值的返回值，返回 false 就表示这个事件没有被处理，还会继续向下传递，返回 true 就表示这个事件已经被处理掉了，从而不会再继续向下传递。举个简单点的例子，如果我们在 RequestListener 的 onResourceReady() 方法中返回了 true，那么就不会再回调 Target 的 onResourceReady() 方法了。</p>
<p>关于 listener() 方法的用法就讲这么多，不过还是老规矩，我们再来看一下它的源码是怎么实现的吧。</p>
<p>首先，listener() 方法是定义在 GenericRequestBuilder 类当中的，而我们传入到 listener() 方法中的实例则会赋值到一个 requestListener 变量当中，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; implements Cloneable &#123;</div><div class="line"></div><div class="line">    private RequestListener&lt;? super ModelType, TranscodeType&gt; requestListener;</div><div class="line">    ...</div><div class="line"></div><div class="line">    public GenericRequestBuilder&lt;ModelType, DataType, ResourceType, TranscodeType&gt; listener(</div><div class="line">            RequestListener&lt;? super ModelType, TranscodeType&gt; requestListener) &#123;</div><div class="line">        this.requestListener = requestListener;</div><div class="line">        return this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来在构建GenericRequest的时候这个变量也会被一起传进去，最后在图片加载完成的时候，我们会看到如下逻辑：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public final class GenericRequest&lt;A, T, Z, R&gt; implements Request, SizeReadyCallback,</div><div class="line">        ResourceCallback &#123;</div><div class="line"></div><div class="line">    private RequestListener&lt;? super A, R&gt; requestListener;</div><div class="line">    ...</div><div class="line"></div><div class="line">    private void onResourceReady(Resource&lt;?&gt; resource, R result) &#123;</div><div class="line">        boolean isFirstResource = isFirstReadyResource();</div><div class="line">        status = Status.COMPLETE;</div><div class="line">        this.resource = resource;</div><div class="line">        if (requestListener == null || !requestListener.onResourceReady(result, model, target,</div><div class="line">                loadedFromMemoryCache, isFirstResource)) &#123;</div><div class="line">            GlideAnimation&lt;R&gt; animation = animationFactory.build(loadedFromMemoryCache, isFirstResource);</div><div class="line">            target.onResourceReady(result, animation);</div><div class="line">        &#125;</div><div class="line">        notifyLoadSuccess();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里在第 11 行会先回调 requestListener 的 onResourceReady() 方法，只有当这个 onResourceReady() 方法返回 false 的时候，才会继续调用 Target 的 onResourceReady() 方法，这也就是 listener() 方法的实现原理。</p>
<p>另外一个 onException() 方法的实现机制也是一模一样的，代码同样是在 GenericRequest 类中，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public final class GenericRequest&lt;A, T, Z, R&gt; implements Request, SizeReadyCallback,</div><div class="line">        ResourceCallback &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void onException(Exception e) &#123;</div><div class="line">        status = Status.FAILED;</div><div class="line">        if (requestListener == null || </div><div class="line">                !requestListener.onException(e, model, target, isFirstReadyResource())) &#123;</div><div class="line">            setErrorPlaceholder(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这里会在第 9 行回调 requestListener 的 onException() 方法，只有在 onException() 方法返回 false 的情况下才会继续调用 setErrorPlaceholder() 方法。也就是说，如果我们在 onException() 方法中返回了 true，那么 Glide 请求中使用 error(int resourceId) 方法设置的异常占位图就失效了。</p>
<p>这样我们也就将 listener() 方法的全部实现原理都分析完了。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/FRAMEWORK/" rel="tag"><i class="fa fa-tag"></i> FRAMEWORK</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/1902/01/09/07 THIRD PARY FRAMEWORK/13 Glide 缓存机制/" rel="next" title="13 Glide 缓存机制">
                <i class="fa fa-chevron-left"></i> 13 Glide 缓存机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/1902/01/11/07 THIRD PARY FRAMEWORK/15 Glide 图片变换功能/" rel="prev" title="15 Glide 图片变换功能">
                15 Glide 图片变换功能 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="先小涛" />
            
              <p class="site-author-name" itemprop="name">先小涛</p>
              <p class="site-description motion-element" itemprop="description">我至诚我道</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">160</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xianxiaotao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/9fe7b66d2982" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-globe"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xianxiaotao@icloud.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.android.google.cn/reference?hl=en" title="ANDROID API" target="_blank">ANDROID API</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.iconfont.cn/" title="ICON" target="_blank">ICON</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#回调的源码实现"><span class="nav-text">回调的源码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#into"><span class="nav-text">into()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#preload"><span class="nav-text">preload()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#downloadOnly"><span class="nav-text">downloadOnly()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#listener"><span class="nav-text">listener()</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">先小涛</span>

  
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共381.9k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'rbnnUjJovf4WCIErS35Hwons-gzGzoHsz',
        appKey: 'ywF5FLP3tubCiWyrJoxH7gJq',
        placeholder: 'ヾﾉ≧∀≦)o 来呀！快活呀！',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
